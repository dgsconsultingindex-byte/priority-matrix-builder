<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrioBox â€” Focus What Matters</title>
  <meta name="description" content="PrioBox â€” Eisenhower priority matrix with due dates, labels, calendar export and cloud sync." />
  <style>
    :root{
      --bg: #f6f8fa;
      --panel: #ffffff;
      --panel-hover: #fafbfc;
      --border: #d0d7de;
      --muted: #e1e4e8;
      --text: #1f2328;
      --text-secondary: #57606a;
      --accent-1: #0969da;
      --accent-2: #0550ae;
      --accent-light: #ddf4ff;
      --accent-border: #54aeff;
      --on-time: #1a7f37;
      --on-time-bg: #dafbe1;
      --approach: #bf8700;
      --approach-bg: #fff8c5;
      --overdue: #cf222e;
      --overdue-bg: #ffebe9;
      --tag-client: #0969da;
      --tag-client-bg: #ddf4ff;
      --tag-personal: #8250df;
      --tag-personal-bg: #fbefff;
      --tag-urgent: #cf222e;
      --tag-urgent-bg: #ffebe9;
      --shadow-sm: rgba(27,31,36,0.04);
      --shadow-md: rgba(27,31,36,0.08);
      --shadow-lg: rgba(27,31,36,0.12);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --gap: 1rem;
      --ui-h: 44px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.5}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:32px;flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center}
    .brand svg{height:48px;width:48px}
    .brand h1{margin:0;font-size:1.5rem;font-weight:700}
    .brand p{margin:0;font-size:0.9rem;color:var(--text-secondary)}

    .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.95);z-index:9999;font-size:1.1rem;color:var(--text);transition:opacity .3s ease}
    .loading-hidden{opacity:0;pointer-events:none}

    .view-toggle{display:flex;gap:4px;background:var(--panel);padding:4px;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border)}
    .view-toggle button{padding:10px 20px;border:none;background:transparent;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;font-size:0.95rem;color:var(--text-secondary);transition:var(--transition)}
    .view-toggle button:hover{background:var(--panel-hover);color:var(--text)}
    .view-toggle button.active{background:var(--accent-1);color:white;box-shadow:0 2px 4px var(--shadow-sm)}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:20px 0}
    .stat-card{background:var(--panel);padding:24px;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);display:flex;flex-direction:column;gap:12px;transition:var(--transition)}
    .stat-card:hover{box-shadow:0 4px 16px var(--shadow-md);transform:translateY(-2px)}
    .stat-value{font-size:2.5rem;font-weight:700;color:var(--accent-1);line-height:1}
    .stat-label{font-size:0.95rem;color:var(--text-secondary);font-weight:500;text-transform:uppercase;letter-spacing:0.05em}
    .stat-trend{font-size:0.9rem;color:var(--text-secondary)}
    .chart-bar{height:6px;background:var(--muted);border-radius:999px;overflow:hidden;margin-top:8px}
    .chart-fill{height:100%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));transition:width .4s cubic-bezier(0.4, 0, 0.2, 1)}

    .daily-hero{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:white;padding:32px;border-radius:var(--radius-lg);margin:20px 0;box-shadow:0 8px 24px var(--shadow-lg)}
    .daily-hero h2{margin:0 0 8px 0;font-size:2rem;font-weight:700;letter-spacing:-0.02em}
    .daily-hero p{margin:0;opacity:0.95;font-size:1.1rem}
    .focus-list{display:flex;flex-direction:column;gap:12px;margin-top:20px}

    .subtasks{margin-top:8px;padding-left:8px;border-left:2px solid var(--muted)}
    .subtask{display:flex;gap:8px;align-items:center;padding:4px 0;font-size:0.9rem}
    .subtask input[type="checkbox"]{cursor:pointer;width:16px;height:16px}
    .subtask.completed{opacity:0.6;text-decoration:line-through}
    .subtask-add{color:var(--accent-1);cursor:pointer;font-size:0.85rem;margin-top:4px;padding:4px 0}
    .subtask-add:hover{text-decoration:underline}

    .auth-sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.28);display:none;z-index:120;transition:opacity .22s ease}
    .auth-sheet-backdrop.show{display:block;opacity:1}
    .auth-sheet{position:fixed;left:50%;transform:translateX(-50%);bottom:-100%;width:100%;max-width:720px;background:var(--panel);border-radius:12px 12px 0 0;box-shadow:0 -20px 50px rgba(0,0,0,0.18);padding:20px;z-index:130;transition:bottom .36s cubic-bezier(.2,.9,.3,1)}
    .auth-sheet.show{bottom:0}
    .auth-top{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .auth-top .logo-box{width:56px;height:56px;border-radius:10px;padding:6px;display:flex;align-items:center;justify-content:center}
    .auth-top svg{width:44px;height:44px}
    .auth-title{margin:0}
    .auth-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .auth-row input{flex:1;min-width:200px;height:44px;padding:8px 12px;border-radius:10px;border:1px solid var(--muted);font-size:0.95rem}
    .auth-row button{height:44px;padding:0 14px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
    .auth-note{font-size:0.9rem;color:#546b52;margin-top:8px}

    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:20px 0}
    .controls input[type="text"],.controls input[type="date"],.controls select{height:var(--ui-h);padding:0 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--panel);font-size:0.95rem;box-shadow:0 2px 4px var(--shadow-sm);min-width:160px;transition:var(--transition)}
    .controls input:focus,.controls select:focus{outline:none;border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-light)}
    .controls .btn{height:var(--ui-h);padding:0 20px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:white;font-weight:600;cursor:pointer;white-space:nowrap;transition:var(--transition);box-shadow:0 2px 8px var(--shadow-sm)}
    .controls .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow-md)}
    .controls .btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:0 2px 4px var(--shadow-sm)}
    .controls .btn.ghost:hover{background:var(--panel-hover);border-color:var(--accent-1)}

    .search-row{display:flex;justify-content:center;padding:8px 0}
    .search-row input{width:560px;max-width:100%;height:44px;padding:0 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--panel);font-size:0.95rem;transition:var(--transition)}
    .search-row input:focus{outline:none;border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-light)}

    .filters{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:8px;flex-wrap:wrap;text-align:center}

    .matrix{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .quadrant{background:var(--panel);border-radius:var(--radius-lg);padding:24px;box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);min-height:300px;display:flex;flex-direction:column;transition:var(--transition)}
    .quadrant:hover{box-shadow:0 4px 16px var(--shadow-md)}
    .quad-head{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--muted)}
    .quad-title{font-weight:700;font-size:1.1rem;letter-spacing:-0.01em}
    .quad-sub{font-size:0.9rem;color:var(--text-secondary);margin-top:4px;font-weight:500}
    .progress-bar{width:140px;height:6px;background:var(--muted);border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));transition:width .4s cubic-bezier(0.4, 0, 0.2, 1)}

    .tasks{margin-top:12px;display:flex;flex-direction:column;gap:12px;overflow:auto;padding-bottom:8px;flex:1}

    .task{display:flex;gap:12px;align-items:flex-start;background:var(--panel);padding:16px;border-radius:var(--radius);border:1px solid var(--border);cursor:grab;transition:var(--transition);position:relative}
    .task:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-md);border-color:var(--accent-border)}
    .task.dragging{opacity:0.5;cursor:grabbing}
    .task-left{flex:1;min-width:0}
    .task-title{margin:0;font-weight:600;word-wrap:break-word;font-size:0.95rem;color:var(--text)}
    .task-desc{margin-top:6px;color:var(--text-secondary);font-size:0.9rem;word-wrap:break-word;line-height:1.5}
    .task-due{margin-top:10px;display:inline-block;padding:6px 12px;border-radius:var(--radius-sm);font-weight:600;color:white;font-size:0.85rem}
    .task-controls{display:flex;gap:6px;align-items:center;flex-shrink:0}
    .small-btn{background:transparent;border:none;cursor:pointer;padding:8px;border-radius:var(--radius-sm);font-size:15px;color:var(--text-secondary);transition:var(--transition)}
    .small-btn:hover{background:var(--panel-hover);color:var(--text)}
    .task.completed{opacity:0.5}
    .task.completed .task-title{text-decoration:line-through}

    .due-on-time{border-left:3px solid var(--on-time);background:var(--on-time-bg)}
    .due-approach{border-left:3px solid var(--approach);background:var(--approach-bg)}
    .due-overdue{border-left:3px solid var(--overdue);background:var(--overdue-bg)}

    .tag{display:inline-block;padding:4px 10px;border-radius:var(--radius-sm);font-weight:600;font-size:0.75rem;margin-left:8px}
    .tag-client{background:var(--tag-client-bg);color:var(--tag-client)}
    .tag-personal{background:var(--tag-personal-bg);color:var(--tag-personal)}
    .tag-urgent{background:var(--tag-urgent-bg);color:var(--tag-urgent)}

    .panel-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.25);display:none;z-index:120}
    .panel{position:fixed;right:0;top:0;height:100%;width:420px;max-width:94%;background:var(--panel);box-shadow:-20px 0 60px rgba(0,0,0,0.3);transform:translateX(108%);transition:transform .28s ease;z-index:130;padding:18px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
    .panel.show{transform:translateX(0)}
    .panel-backdrop.show{display:block}

    .panel input[type="text"],.panel input[type="date"],.panel select,.panel textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--muted);background:var(--panel);box-sizing:border-box;font-size:0.95rem}
    .panel textarea{min-height:100px;resize:vertical;font-family:inherit}
    .panel .row{display:flex;gap:8px;flex-wrap:wrap}
    .panel .row>*{flex:1;min-width:140px}

    .onboard{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:140;pointer-events:none;opacity:0;background:rgba(0,0,0,0.3);transition:opacity .3s ease}
    .onboard.show{pointer-events:auto;opacity:1}
    .onboard-card{background:var(--panel);padding:20px;border-radius:12px;width:min(760px,94%);box-shadow:0 30px 70px rgba(0,0,0,0.28);max-height:90vh;overflow-y:auto}

    .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
    .empty-state svg{width:80px;height:80px;margin-bottom:16px;opacity:0.5}
    .empty-state h3{margin:16px 0 8px 0;font-size:1.3rem;color:var(--text)}
    .empty-state p{margin:0;font-size:0.95rem}

    footer{text-align:center;color:#557a5a;margin-top:32px;font-size:0.9rem;padding-bottom:20px}

    @media(max-width:900px){
      .matrix{grid-template-columns:1fr}
      .controls input[type="text"]{min-width:130px}
      .panel{width:100%}
      header{justify-content:center}
      .stats-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">Loading your priorities...</div>

  <div class="wrap" id="root">
    <header>
      <div class="brand">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <rect x="10" y="10" width="35" height="35" rx="5" fill="#2ea043"/>
          <rect x="55" y="10" width="35" height="35" rx="5" fill="#4caf50"/>
          <rect x="10" y="55" width="35" height="35" rx="5" fill="#66bb6a"/>
          <rect x="55" y="55" width="35" height="35" rx="5" fill="#81c784"/>
        </svg>
        <div>
          <h1>PrioBox</h1>
          <p>Focus what matters</p>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="signOutBtn" style="display:none;height:40px;padding:8px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer">Sign Out</button>
        <button id="accountBtn" style="display:none;height:40px;padding:8px 12px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer">Account</button>
      </div>
    </header>

    <div id="authBackdrop" class="auth-sheet-backdrop"></div>
    <div id="authSheet" class="auth-sheet" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="auth-top">
        <div class="logo-box">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="10" width="35" height="35" rx="5" fill="#2ea043"/>
            <rect x="55" y="10" width="35" height="35" rx="5" fill="#4caf50"/>
            <rect x="10" y="55" width="35" height="35" rx="5" fill="#66bb6a"/>
            <rect x="55" y="55" width="35" height="35" rx="5" fill="#81c784"/>
          </svg>
        </div>
        <div>
          <h2 id="authTitle" class="auth-title">Welcome to <strong>PrioBox</strong></h2>
          <div class="auth-note">Cloud sync available - sign in optional (works offline too!)</div>
        </div>
      </div>
      <div class="auth-row">
        <input id="authEmail" type="email" placeholder="you@example.com" aria-label="Email" />
        <button id="authSend">Send Magic Link</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;flex-wrap:wrap;gap:8px">
        <div style="font-size:0.9rem;color:#4f6b51">No password needed</div>
        <button id="authClose" style="background:transparent;border:none;color:#4f6b51;cursor:pointer;text-decoration:underline">Continue Without Sign In</button>
      </div>
    </div>

    <div id="appArea" style="display:none">
      <div style="display:flex;justify-content:center;margin:16px 0">
        <div class="view-toggle">
          <button id="viewDaily" class="active">Daily Focus</button>
          <button id="viewMatrix">Full Matrix</button>
          <button id="viewStats">Analytics</button>
        </div>
      </div>

      <div id="dailyView">
        <div class="daily-hero">
          <h2>Today's Focus</h2>
          <p id="dailyDate"></p>
        </div>
        
        <div id="dailyStats" class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
          <div class="stat-card">
            <div class="stat-value" id="todayDue">0</div>
            <div class="stat-label">Due Today</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="overdueCount">0</div>
            <div class="stat-label">Overdue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="upcomingCount">0</div>
            <div class="stat-label">This Week</div>
          </div>
        </div>

        <div class="focus-list" id="dailyTasks"></div>
      </div>

      <div id="statsView" style="display:none">
        <h2 style="text-align:center;margin:16px 0">Your Productivity Analytics</h2>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalTasks">0</div>
            <div class="stat-label">Total Tasks</div>
            <div class="stat-trend" id="completionRate"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completedTasks">0</div>
            <div class="stat-label">Completed</div>
            <div class="chart-bar"><div class="chart-fill" id="completedBar"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeTasks">0</div>
            <div class="stat-label">In Progress</div>
            <div class="chart-bar"><div class="chart-fill" id="activeBar"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="overdueStats">0</div>
            <div class="stat-label">Overdue Items</div>
            <div class="stat-trend">Need attention</div>
          </div>
        </div>

        <h3 style="margin:24px 0 12px 0">Focus Distribution</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Do First</div>
            <div class="stat-value" style="font-size:1.5rem" id="doFirstStat">0</div>
            <div class="chart-bar"><div class="chart-fill" id="doFirstBar"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Schedule</div>
            <div class="stat-value" style="font-size:1.5rem" id="scheduleStat">0</div>
            <div class="chart-bar"><div class="chart-fill" id="scheduleBar"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Delegate</div>
            <div class="stat-value" style="font-size:1.5rem" id="delegateStat">0</div>
            <div class="chart-bar"><div class="chart-fill" id="delegateBar"></div></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Eliminate</div>
            <div class="stat-value" style="font-size:1.5rem" id="eliminateStat">0</div>
            <div class="chart-bar"><div class="chart-fill" id="eliminateBar"></div></div>
          </div>
        </div>

        <div style="background:var(--panel);padding:20px;border-radius:var(--radius);margin-top:20px;box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border)">
          <h3>Insights</h3>
          <ul id="insightsList" style="line-height:1.8;color:var(--text-secondary)"></ul>
        </div>
      </div>

      <div id="matrixView" style="display:none">
        <section class="controls" aria-label="Task controls">
          <input id="taskTitle" type="text" placeholder="Task title (required)" />
          <input id="taskDescription" type="text" placeholder="Description (optional)" />
          <input id="taskDue" type="date" />
          <select id="taskQuadrant">
            <option value="do-first">Do First</option>
            <option value="schedule">Schedule</option>
            <option value="delegate">Delegate</option>
            <option value="eliminate">Eliminate</option>
          </select>
          <select id="taskLabel">
            <option value="">No label</option>
            <option value="client">Client</option>
            <option value="personal">Personal</option>
            <option value="urgent">Urgent</option>
          </select>
          <button class="btn" id="addBtn">Add Task</button>
          <button class="btn ghost" id="clearBtn">Clear All</button>
          <button class="btn ghost" id="demoBtn">Demo Data</button>
          <button id="exportBtn" class="btn ghost" title="Export JSON">Export</button>
          <button id="importBtn" class="btn ghost" title="Import JSON">Import</button>
        </section>

        <div class="search-row">
          <input id="searchInput" type="search" placeholder="Search tasks by title, description, due date, label..." />
        </div>

        <div class="filters">
          <button id="toggleCompletedBtn" style="height:36px;padding:8px 12px;border-radius:8px;background:var(--panel);border:1px solid var(--border);cursor:pointer">Hide Completed</button>
          <div style="font-size:0.9rem;color:#4f6b51">Double-click to edit â€¢ Drag between quadrants</div>
        </div>

        <section class="matrix" aria-label="Priority matrix">
          <div class="quadrant do-first" data-q="do-first">
            <div class="quad-head">
              <div><div class="quad-title">Do First</div><div class="quad-sub">Urgent & Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="do-first-count">(0/0 done)</div>
                <div class="progress-bar"><div id="do-first-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="do-first-tasks" aria-live="polite"></div>
          </div>

          <div class="quadrant schedule" data-q="schedule">
            <div class="quad-head">
              <div><div class="quad-title">Schedule</div><div class="quad-sub">Not Urgent but Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="schedule-count">(0/0 done)</div>
                <div class="progress-bar"><div id="schedule-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="schedule-tasks"></div>
          </div>

          <div class="quadrant delegate" data-q="delegate">
            <div class="quad-head">
              <div><div class="quad-title">Delegate</div><div class="quad-sub">Urgent but Not Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="delegate-count">(0/0 done)</div>
                <div class="progress-bar"><div id="delegate-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="delegate-tasks"></div>
          </div>

          <div class="quadrant eliminate" data-q="eliminate">
            <div class="quad-head">
              <div><div class="quad-title">Eliminate</div><div class="quad-sub">Not Urgent & Not Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="eliminate-count">(0/0 done)</div>
                <div class="progress-bar"><div id="eliminate-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="eliminate-tasks"></div>
          </div>
        </section>
      </div>

      <footer>Â© 2025 PrioBox â€” Built by DGS Consulting</footer>
    </div>
  </div>

  <div id="panelBackdrop" class="panel-backdrop"></div>
  <aside id="slidePanel" class="panel" role="dialog" aria-hidden="true">
    <h3 id="panelTitle">Edit task</h3>
    <div class="row">
      <input id="pTitle" type="text" placeholder="Task title" />
    </div>
    <div class="row">
      <input id="pDue" type="date" />
      <select id="pQuadrant">
        <option value="do-first">Do First</option>
        <option value="schedule">Schedule</option>
        <option value="delegate">Delegate</option>
        <option value="eliminate">Eliminate</option>
      </select>
    </div>
    <div class="row">
      <select id="pLabel">
        <option value="">No label</option>
        <option value="client">Client</option>
        <option value="personal">Personal</option>
        <option value="urgent">Urgent</option>
      </select>
      <label style="display:flex;align-items:center;gap:8px;padding:8px"><input id="pCompleted" type="checkbox"> Completed</label>
    </div>
    <div class="row">
      <textarea id="pDesc" placeholder="Description"></textarea>
    </div>

    <h4>Subtasks</h4>
    <div id="subtasksList"></div>
    <div class="subtask-add" id="addSubtaskBtn">+ Add subtask</div>

    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px">
      <button id="panelCancel" class="btn ghost">Cancel</button>
      <button id="panelSave" class="btn">Save</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--muted);margin:12px 0" />
    <div style="display:flex;gap:8px;flex-direction:column">
      <button id="addToCalendarBtn" class="btn ghost">Open Google Calendar</button>
      <button id="downloadICSBtn" class="btn ghost">Download .ics</button>
      <button id="deleteFromPanelBtn" class="btn ghost" style="color:var(--overdue)">Delete Task</button>
    </div>
  </aside>

  <div id="onboard" class="onboard" aria-hidden="true">
    <div class="onboard-card">
      <h2>Welcome to PrioBox</h2>
      <p><strong>New Features:</strong></p>
      <ul style="line-height:1.8">
        <li><strong>Daily Focus</strong> - See today's priorities at a glance</li>
        <li><strong>Analytics</strong> - Track your productivity and completion rates</li>
        <li><strong>Subtasks</strong> - Break down big tasks into manageable steps</li>
        <li><strong>Smart Insights</strong> - Get personalized productivity tips</li>
      </ul>
      <p style="margin-top:12px"><strong>Quick Tips:</strong></p>
      <ol style="line-height:1.8">
        <li>Start with Daily Focus to see what needs attention today</li>
        <li>Add subtasks to complex items for better tracking</li>
        <li>Check Analytics weekly to see your progress trends</li>
      </ol>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;flex-wrap:wrap">
        <button id="onboardSkip" class="btn ghost">Skip</button>
        <button id="onboardDone" class="btn">Got it!</button>
      </div>
    </div>
  </div>

  <input id="importFileInput" type="file" accept="application/json" style="display:none" />

  <script>
    'use strict';

    class TaskStore {
      constructor() {
        this.STORAGE_KEY = 'priobox_tasks';
        this.PREFS_KEY = 'priobox_prefs';
        this.tasks = {};
        this.prefs = { showCompleted: true, theme: 'light', currentView: 'daily', onboardingSeen: false };
        this.listeners = [];
      }

      load() {
        try {
          const rawTasks = localStorage.getItem(this.STORAGE_KEY);
          const rawPrefs = localStorage.getItem(this.PREFS_KEY);
          if (rawTasks) {
            const data = JSON.parse(rawTasks);
            this.tasks = data.tasks || {};
            Object.values(this.tasks).forEach(t => {
              if (!t.subtasks) t.subtasks = [];
              if (!t.createdAt) t.createdAt = Date.now();
            });
          }
          if (rawPrefs) this.prefs = { ...this.prefs, ...JSON.parse(rawPrefs) };
        } catch(e) { console.error('Load error:', e); }
      }

      save() {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ tasks: this.tasks }));
          localStorage.setItem(this.PREFS_KEY, JSON.stringify(this.prefs));
          this.notify();
        } catch(e) { console.error('Save error:', e); }
      }

      subscribe(callback) {
        this.listeners.push(callback);
        return () => { this.listeners = this.listeners.filter(l => l !== callback); };
      }

      notify() { this.listeners.forEach(cb => cb()); }

      addTask(task) {
        const id = this.generateId();
        this.tasks[id] = { id, title: task.title || 'Untitled', description: task.description || '', due: task.due || '', quadrant: task.quadrant || 'do-first', label: task.label || '', completed: false, subtasks: [], createdAt: Date.now(), ...task };
        this.save();
        return id;
      }

      updateTask(id, updates) {
        if (!this.tasks[id]) return false;
        this.tasks[id] = { ...this.tasks[id], ...updates };
        this.save();
        return true;
      }

      deleteTask(id) {
        if (!this.tasks[id]) return false;
        delete this.tasks[id];
        this.save();
        return true;
      }

      getTask(id) { return this.tasks[id]; }
      getAllTasks() { return Object.values(this.tasks); }
      getTasksByQuadrant(quadrant) { return this.getAllTasks().filter(t => t.quadrant === quadrant); }

      toggleComplete(id) {
        const task = this.tasks[id];
        if (!task) return false;
        task.completed = !task.completed;
        this.save();
        return true;
      }

      generateId() { return `t-${Date.now()}-${Math.floor(Math.random() * 9000 + 1000)}`; }
      setPref(key, value) { this.prefs[key] = value; this.save(); }
      getPref(key) { return this.prefs[key]; }
    }

    const Utils = {
      escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      formatDate(dateStr) {
        if (!dateStr) return '';
        try { return new Date(dateStr).toISOString().slice(0, 10); } catch { return dateStr; }
      },
      getDaysDiff(dateStr) {
        if (!dateStr) return null;
        const today = new Date(); today.setHours(0,0,0,0);
        const date = new Date(dateStr); date.setHours(0,0,0,0);
        return Math.round((date - today) / (1000 * 60 * 60 * 24));
      },
      getUrgencyClass(dateStr) {
        const diff = this.getDaysDiff(dateStr);
        if (diff === null) return '';
        if (diff < 0) return 'due-overdue';
        if (diff <= 2) return 'due-approach';
        return 'due-on-time';
      },
      debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), wait);
        };
      },
      formatDateFull(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }
    };

    const Calendar = {
      openGoogleCalendar(task) {
        if (!task || !task.due) { alert('Task must have a due date to add to Google Calendar'); return; }
        const start = new Date(task.due + 'T09:00:00');
        const end = new Date(start.getTime() + 60 * 60 * 1000);
        const formatDate = (dt) => dt.toISOString().slice(0, 19).replace(/-|:/g, '') + 'Z';
        const dates = `${formatDate(start)}/${formatDate(end)}`;
        const text = encodeURIComponent(task.title || 'Task');
        const details = encodeURIComponent(task.description || '');
        window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}`, '_blank');
      },
      downloadICS(task) {
        if (!task || !task.due) { alert('Task must have a due date to export to calendar'); return; }
        const start = new Date(task.due + 'T09:00:00');
        const end = new Date(start.getTime() + 60 * 60 * 1000);
        const formatDate = (dt) => dt.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const ics = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//PrioBox//EN', 'BEGIN:VEVENT', `UID:${task.id}@priobox`, `DTSTAMP:${formatDate(new Date())}`, `DTSTART:${formatDate(start)}`, `DTEND:${formatDate(end)}`, `SUMMARY:${(task.title || '').replace(/[,;]/g, '')}`, `DESCRIPTION:${(task.description||'').replace(/\n/g,'\\n').replace(/[,;]/g, '')}`, 'END:VEVENT', 'END:VCALENDAR'].join('\r\n');
        const blob = new Blob([ics], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${(task.title || 'task').slice(0, 40)}.ics`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
    };

    class TaskRenderer {
      constructor(store) {
        this.store = store;
        this.searchTerm = '';
      }
      setSearchTerm(term) { this.searchTerm = term.toLowerCase().trim(); }
      matchesSearch(task) {
        if (!this.searchTerm) return true;
        const searchStr = (task.title + ' ' + (task.description || '') + ' ' + (task.due || '') + ' ' + (task.label || '')).toLowerCase();
        return searchStr.includes(this.searchTerm);
      }
      createTaskElement(task) {
        const div = document.createElement('div');
        div.className = 'task'; div.dataset.id = task.id;
        if (task.completed) div.classList.add('completed');
        const urgencyClass = Utils.getUrgencyClass(task.due);
        if (urgencyClass) div.classList.add(urgencyClass);
        const left = document.createElement('div'); left.className = 'task-left';
        let titleHtml = `<div class="task-title">${Utils.escapeHtml(task.title)}`;
        if (task.label) {
          const labelClass = `tag-${task.label}`;
          titleHtml += ` <span class="tag ${labelClass}">${task.label.charAt(0).toUpperCase() + task.label.slice(1)}</span>`;
        }
        titleHtml += `</div>`;
        let contentHtml = titleHtml;
        if (task.description) contentHtml += `<div class="task-desc">${Utils.escapeHtml(task.description)}</div>`;
        if (task.subtasks && task.subtasks.length > 0) {
          const completedSubs = task.subtasks.filter(s => s.completed).length;
          contentHtml += `<div style="font-size:0.85rem;color:var(--text-secondary);margin-top:4px">âœ“ ${completedSubs}/${task.subtasks.length} subtasks</div>`;
        }
        if (task.due) contentHtml += `<div class="task-due">${Utils.escapeHtml(task.due)}</div>`;
        left.innerHTML = contentHtml;
        const controls = document.createElement('div'); controls.className = 'task-controls';
        controls.appendChild(this.createButton(task.completed ? 'â†º' : 'âœ”', task.completed ? 'Mark incomplete' : 'Mark complete', () => app.toggleComplete(task.id)));
        controls.appendChild(this.createButton('âœŽ', 'Edit', () => app.openEditPanel(task.id)));
        controls.appendChild(this.createButton('ðŸ“…', 'Add to calendar', () => { if (task.due) { Calendar.openGoogleCalendar(task); } else { alert('Please add a due date first'); } }));
        controls.appendChild(this.createButton('âœ•', 'Delete', () => app.deleteTask(task.id)));
        div.appendChild(controls); div.appendChild(left);
        this.setupDrag(div);
        div.addEventListener('dblclick', () => app.openEditPanel(task.id));
        return div;
      }
      createButton(text, title, onClick) {
        const btn = document.createElement('button');
        btn.className = 'small-btn'; btn.textContent = text; btn.title = title;
        btn.onclick = (e) => { e.stopPropagation(); onClick(); };
        return btn;
      }
      setupDrag(element) {
        element.draggable = true;
        element.addEventListener('dragstart', (e) => { element.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', element.dataset.id); });
        element.addEventListener('dragend', () => { element.classList.remove('dragging'); });
      }
    }

    class PrioBoxApp {
      constructor() {
        this.store = new TaskStore();
        this.renderer = new TaskRenderer(this.store);
        this.currentView = 'daily';
        this.editingTaskId = null;
        this.quadrants = ['do-first', 'schedule', 'delegate', 'eliminate'];
        this.initializeElements();
        this.setupEventListeners();
        this.store.subscribe(() => this.render());
      }

      initializeElements() {
        this.loadingEl = document.getElementById('loading');
        this.authBackdrop = document.getElementById('authBackdrop');
        this.authSheet = document.getElementById('authSheet');
        this.authClose = document.getElementById('authClose');
        this.authSend = document.getElementById('authSend');
        this.appArea = document.getElementById('appArea');
        this.viewDaily = document.getElementById('viewDaily');
        this.viewMatrix = document.getElementById('viewMatrix');
        this.viewStats = document.getElementById('viewStats');
        this.dailyView = document.getElementById('dailyView');
        this.matrixView = document.getElementById('matrixView');
        this.statsView = document.getElementById('statsView');
        this.addBtn = document.getElementById('addBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.demoBtn = document.getElementById('demoBtn');
        this.exportBtn = document.getElementById('exportBtn');
        this.importBtn = document.getElementById('importBtn');
        this.importFileInput = document.getElementById('importFileInput');
        this.taskTitle = document.getElementById('taskTitle');
        this.taskDescription = document.getElementById('taskDescription');
        this.taskDue = document.getElementById('taskDue');
        this.taskQuadrant = document.getElementById('taskQuadrant');
        this.taskLabel = document.getElementById('taskLabel');
        this.searchInput = document.getElementById('searchInput');
        this.toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
        this.panelBackdrop = document.getElementById('panelBackdrop');
        this.slidePanel = document.getElementById('slidePanel');
        this.pTitle = document.getElementById('pTitle');
        this.pDesc = document.getElementById('pDesc');
        this.pDue = document.getElementById('pDue');
        this.pQuadrant = document.getElementById('pQuadrant');
        this.pLabel = document.getElementById('pLabel');
        this.pCompleted = document.getElementById('pCompleted');
        this.panelSave = document.getElementById('panelSave');
        this.panelCancel = document.getElementById('panelCancel');
        this.subtasksList = document.getElementById('subtasksList');
        this.addSubtaskBtn = document.getElementById('addSubtaskBtn');
        this.addToCalendarBtn = document.getElementById('addToCalendarBtn');
        this.downloadICSBtn = document.getElementById('downloadICSBtn');
        this.deleteFromPanelBtn = document.getElementById('deleteFromPanelBtn');
        this.onboard = document.getElementById('onboard');
        this.onboardDone = document.getElementById('onboardDone');
        this.onboardSkip = document.getElementById('onboardSkip');
      }

      setupEventListeners() {
        this.authClose.addEventListener('click', () => this.closeAuth());
        this.authSend.addEventListener('click', () => this.handleAuthSend());
        this.viewDaily.addEventListener('click', () => this.switchView('daily'));
        this.viewMatrix.addEventListener('click', () => this.switchView('matrix'));
        this.viewStats.addEventListener('click', () => this.switchView('stats'));
        this.addBtn.addEventListener('click', () => this.handleAddTask());
        this.clearBtn.addEventListener('click', () => this.handleClearAll());
        this.demoBtn.addEventListener('click', () => this.loadDemoData());
        this.exportBtn.addEventListener('click', () => this.exportTasks());
        this.importBtn.addEventListener('click', () => this.importFileInput.click());
        this.importFileInput.addEventListener('change', (e) => this.importTasks(e));
        this.searchInput.addEventListener('input', Utils.debounce(() => { this.renderer.setSearchTerm(this.searchInput.value); this.render(); }, 300));
        this.toggleCompletedBtn.addEventListener('click', () => this.toggleCompletedVisibility());
        this.panelBackdrop.addEventListener('click', () => this.closePanel());
        this.panelCancel.addEventListener('click', () => this.closePanel());
        this.panelSave.addEventListener('click', () => this.savePanel());
        this.addSubtaskBtn.addEventListener('click', () => this.addSubtask());
        this.addToCalendarBtn.addEventListener('click', () => { if (this.editingTaskId) { const task = this.store.getTask(this.editingTaskId); if (task) Calendar.openGoogleCalendar(task); } });
        this.downloadICSBtn.addEventListener('click', () => { if (this.editingTaskId) { const task = this.store.getTask(this.editingTaskId); if (task) Calendar.downloadICS(task); } });
        this.deleteFromPanelBtn.addEventListener('click', () => { if (this.editingTaskId) { this.deleteTask(this.editingTaskId); this.closePanel(); } });
        this.onboardDone.addEventListener('click', () => this.closeOnboarding());
        this.onboardSkip.addEventListener('click', () => this.closeOnboarding());
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        this.setupDragTargets();
      }

      setupDragTargets() {
        document.querySelectorAll('.quadrant').forEach(qEl => {
          qEl.addEventListener('dragover', (e) => { e.preventDefault(); qEl.style.background = 'rgba(46, 160, 67, 0.05)'; });
          qEl.addEventListener('dragleave', () => { qEl.style.background = ''; });
          qEl.addEventListener('drop', (e) => { e.preventDefault(); qEl.style.background = ''; const taskId = e.dataTransfer.getData('text/plain'); const targetQuadrant = qEl.dataset.q; if (taskId && targetQuadrant) this.store.updateTask(taskId, { quadrant: targetQuadrant }); });
        });
      }

      switchView(view) {
        this.currentView = view;
        this.store.setPref('currentView', view);
        [this.viewDaily, this.viewMatrix, this.viewStats].forEach(btn => btn.classList.remove('active'));
        this.dailyView.style.display = 'none';
        this.matrixView.style.display = 'none';
        this.statsView.style.display = 'none';
        if (view === 'daily') { this.viewDaily.classList.add('active'); this.dailyView.style.display = 'block'; this.renderDailyView(); }
        else if (view === 'matrix') { this.viewMatrix.classList.add('active'); this.matrixView.style.display = 'block'; this.renderMatrixView(); }
        else if (view === 'stats') { this.viewStats.classList.add('active'); this.statsView.style.display = 'block'; this.renderStatsView(); }
      }

      render() {
        if (this.currentView === 'daily') this.renderDailyView();
        else if (this.currentView === 'matrix') this.renderMatrixView();
        else if (this.currentView === 'stats') this.renderStatsView();
      }

      renderDailyView() {
        const today = new Date();
        document.getElementById('dailyDate').textContent = Utils.formatDateFull(today);
        const allTasks = this.store.getAllTasks();
        const todayTasks = allTasks.filter(t => { const diff = Utils.getDaysDiff(t.due); return diff === 0 && !t.completed; });
        const overdueTasks = allTasks.filter(t => { const diff = Utils.getDaysDiff(t.due); return diff !== null && diff < 0 && !t.completed; });
        const upcomingTasks = allTasks.filter(t => { const diff = Utils.getDaysDiff(t.due); return diff !== null && diff > 0 && diff <= 7 && !t.completed; });
        document.getElementById('todayDue').textContent = todayTasks.length;
        document.getElementById('overdueCount').textContent = overdueTasks.length;
        document.getElementById('upcomingCount').textContent = upcomingTasks.length;
        const container = document.getElementById('dailyTasks');
        container.innerHTML = '';
        if (overdueTasks.length > 0) this.renderTaskSection(container, 'Overdue', overdueTasks, 'var(--overdue)');
        if (todayTasks.length > 0) this.renderTaskSection(container, 'Due Today', todayTasks, 'var(--accent-1)');
        if (upcomingTasks.length > 0) this.renderTaskSection(container, 'This Week', upcomingTasks, 'var(--approach)');
        if (overdueTasks.length === 0 && todayTasks.length === 0 && upcomingTasks.length === 0) {
          container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="10" width="35" height="35" rx="5" fill="currentColor"/><rect x="55" y="10" width="35" height="35" rx="5" fill="currentColor"/><rect x="10" y="55" width="35" height="35" rx="5" fill="currentColor"/><rect x="55" y="55" width="35" height="35" rx="5" fill="currentColor"/></svg><h3>All caught up!</h3><p>No urgent tasks. Great job staying organized.</p></div>';
        }
      }

      renderTaskSection(container, title, tasks, color) {
        const section = document.createElement('div');
        section.innerHTML = `<h3 style="color:${color};margin:16px 0 8px 0">${title}</h3>`;
        container.appendChild(section);
        tasks.sort((a, b) => { if (a.due && b.due) return new Date(a.due) - new Date(b.due); return 0; }).forEach(task => { container.appendChild(this.renderer.createTaskElement(task)); });
      }

      renderMatrixView() {
        this.quadrants.forEach(q => {
          const container = document.getElementById(`${q}-tasks`);
          if (!container) return;
          container.innerHTML = '';
          const tasks = this.store.getTasksByQuadrant(q);
          tasks.sort((a, b) => { if (a.due && b.due) return new Date(a.due) - new Date(b.due); if (a.due) return -1; if (b.due) return 1; return (a.createdAt || 0) - (b.createdAt || 0); });
          tasks.forEach(task => {
            if (!this.renderer.matchesSearch(task)) return;
            const node = this.renderer.createTaskElement(task);
            if (!this.store.getPref('showCompleted') && task.completed) node.style.display = 'none';
            container.appendChild(node);
          });
        });
        this.updateQuadrantStats();
      }

      updateQuadrantStats() {
        this.quadrants.forEach(q => {
          const tasks = this.store.getTasksByQuadrant(q);
          const total = tasks.length;
          const done = tasks.filter(t => t.completed).length;
          const pct = total === 0 ? 0 : Math.round((done / total) * 100);
          const countEl = document.getElementById(`${q}-count`);
          const fillEl = document.getElementById(`${q}-fill`);
          if (countEl) countEl.textContent = `(${done}/${total} done)`;
          if (fillEl) fillEl.style.width = pct + '%';
        });
      }

      renderStatsView() {
        const allTasks = this.store.getAllTasks();
        const total = allTasks.length;
        const completed = allTasks.filter(t => t.completed).length;
        const active = total - completed;
        const overdue = allTasks.filter(t => { const diff = Utils.getDaysDiff(t.due); return diff !== null && diff < 0 && !t.completed; }).length;
        document.getElementById('totalTasks').textContent = total;
        document.getElementById('completedTasks').textContent = completed;
        document.getElementById('activeTasks').textContent = active;
        document.getElementById('overdueStats').textContent = overdue;
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
        document.getElementById('completionRate').textContent = `${completionRate}% completion rate`;
        document.getElementById('completedBar').style.width = completionRate + '%';
        document.getElementById('activeBar').style.width = (total > 0 ? (active / total) * 100 : 0) + '%';
        this.quadrants.forEach(q => {
          const count = allTasks.filter(t => t.quadrant === q).length;
          const pct = total > 0 ? Math.round((count / total) * 100) : 0;
          const label = q.replace('-', '');
          const statEl = document.getElementById(`${label}Stat`);
          const barEl = document.getElementById(`${label}Bar`);
          if (statEl) statEl.textContent = count;
          if (barEl) barEl.style.width = pct + '%';
        });
        this.renderInsights(allTasks, total, completed, overdue, completionRate);
      }

      renderInsights(allTasks, total, completed, overdue, completionRate) {
        const insights = [];
        if (overdue > 0) insights.push(`You have ${overdue} overdue task${overdue > 1 ? 's' : ''} that need immediate attention.`);
        if (completionRate >= 70) insights.push(`Great job! You're completing ${completionRate}% of your tasks.`);
        else if (completionRate < 30 && total > 5) insights.push(`Consider breaking down tasks into smaller, more manageable pieces.`);
        const doFirstCount = allTasks.filter(t => t.quadrant === 'do-first').length;
        const eliminateCount = allTasks.filter(t => t.quadrant === 'eliminate').length;
        if (doFirstCount > total * 0.5 && total > 5) insights.push(`Over half your tasks are in "Do First". Consider if some could be scheduled or delegated.`);
        if (eliminateCount > 5) insights.push(`You have ${eliminateCount} tasks in "Eliminate". Consider removing low-value items.`);
        if (total === completed && total > 0) insights.push(`All tasks completed! Time to set new goals.`);
        if (insights.length === 0) insights.push(`Keep adding tasks and tracking your progress to see personalized insights.`);
        document.getElementById('insightsList').innerHTML = insights.map(i => `<li>${i}</li>`).join('');
      }

      handleAddTask() {
        const title = this.taskTitle.value.trim();
        if (!title) { this.taskTitle.focus(); return; }
        this.store.addTask({ title, description: this.taskDescription.value.trim(), due: this.taskDue.value || '', quadrant: this.taskQuadrant.value || 'do-first', label: this.taskLabel.value || '' });
        this.taskTitle.value = ''; this.taskDescription.value = ''; this.taskDue.value = ''; this.taskQuadrant.value = 'do-first'; this.taskLabel.value = '';
      }

      toggleComplete(taskId) { this.store.toggleComplete(taskId); }
      deleteTask(taskId) { if (!confirm('Delete this task?')) return; this.store.deleteTask(taskId); }
      handleClearAll() { if (!confirm('Clear all tasks? This cannot be undone.')) return; this.store.tasks = {}; this.store.save(); }

      openEditPanel(taskId) {
        this.editingTaskId = taskId;
        const task = this.store.getTask(taskId);
        if (!task) return;
        this.pTitle.value = task.title || '';
        this.pDesc.value = task.description || '';
        this.pDue.value = task.due || '';
        this.pQuadrant.value = task.quadrant || 'do-first';
        this.pLabel.value = task.label || '';
        this.pCompleted.checked = !!task.completed;
        document.getElementById('panelTitle').textContent = 'Edit task';
        this.renderSubtasks();
        this.showPanel(true);
      }

      showPanel(show) {
        if (show) {
          this.slidePanel.classList.add('show');
          this.panelBackdrop.classList.add('show');
          this.slidePanel.setAttribute('aria-hidden', 'false');
        } else {
          this.slidePanel.classList.remove('show');
          this.panelBackdrop.classList.remove('show');
          this.slidePanel.setAttribute('aria-hidden', 'true');
          this.editingTaskId = null;
        }
      }

      closePanel() { this.showPanel(false); }

      savePanel() {
        if (!this.editingTaskId) return;
        const task = this.store.getTask(this.editingTaskId);
        if (!task) { this.closePanel(); return; }
        this.store.updateTask(this.editingTaskId, {
          title: this.pTitle.value.trim() || task.title,
          description: this.pDesc.value.trim(),
          due: this.pDue.value || '',
          quadrant: this.pQuadrant.value,
          label: this.pLabel.value || '',
          completed: !!this.pCompleted.checked
        });
        this.closePanel();
      }

      renderSubtasks() {
        if (!this.editingTaskId) return;
        const task = this.store.getTask(this.editingTaskId);
        if (!task) return;
        const subtasks = task.subtasks || [];
        this.subtasksList.innerHTML = '';
        subtasks.forEach((st, idx) => {
          const div = document.createElement('div');
          div.className = 'subtask' + (st.completed ? ' completed' : '');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = st.completed;
          checkbox.addEventListener('change', () => {
            task.subtasks[idx].completed = checkbox.checked;
            this.store.save();
            this.renderSubtasks();
          });
          const text = document.createElement('span');
          text.textContent = st.text;
          text.style.flex = '1';
          const delBtn = document.createElement('button');
          delBtn.textContent = 'âœ•';
          delBtn.className = 'small-btn';
          delBtn.onclick = () => {
            task.subtasks.splice(idx, 1);
            this.store.save();
            this.renderSubtasks();
          };
          div.appendChild(checkbox);
          div.appendChild(text);
          div.appendChild(delBtn);
          this.subtasksList.appendChild(div);
        });
      }

      addSubtask() {
        if (!this.editingTaskId) return;
        const task = this.store.getTask(this.editingTaskId);
        if (!task) return;
        const text = prompt('Subtask:');
        if (!text || !text.trim()) return;
        if (!task.subtasks) task.subtasks = [];
        task.subtasks.push({ text: text.trim(), completed: false });
        this.store.save();
        this.renderSubtasks();
      }

      exportTasks() {
        const data = JSON.stringify({ tasks: this.store.tasks }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'priobox-tasks.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      importTasks(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            if (obj.tasks) {
              Object.values(obj.tasks).forEach(t => {
                let id = t.id;
                if (!id || this.store.tasks[id]) id = this.store.generateId();
                this.store.tasks[id] = { ...t, id };
              });
              this.store.save();
              alert('Imported tasks successfully');
            } else {
              alert('No tasks found in file');
            }
          } catch(e) {
            alert('Invalid JSON file');
            console.error(e);
          }
        };
        reader.readAsText(file);
        this.importFileInput.value = '';
      }

      loadDemoData() {
        if (Object.keys(this.store.tasks).length > 0) {
          if (!confirm('This will replace your current tasks. Continue?')) return;
        }
        this.store.tasks = {};
        const today = new Date();
        const tomorrow = new Date(today.getTime() + 86400000);
        const nextWeek = new Date(today.getTime() + 7 * 86400000);
        const yesterday = new Date(today.getTime() - 86400000);
        const samples = [
          { title: 'Fix critical signup bug', quadrant: 'do-first', due: Utils.formatDate(tomorrow), label: 'client', description: 'Users cannot complete registration', subtasks: [{ text: 'Reproduce the bug', completed: true }, { text: 'Identify root cause', completed: true }, { text: 'Write fix', completed: false }, { text: 'Test solution', completed: false }, { text: 'Deploy to production', completed: false }] },
          { title: 'Plan Q2 roadmap', quadrant: 'schedule', due: Utils.formatDate(nextWeek), label: '', description: 'Strategic planning session with team', subtasks: [{ text: 'Review Q1 results', completed: false }, { text: 'Gather team input', completed: false }, { text: 'Draft objectives', completed: false }] },
          { title: 'Review social media posts', quadrant: 'delegate', due: '', label: 'personal', description: 'Quick 15-minute task', subtasks: [] },
          { title: 'Clean old email subscriptions', quadrant: 'eliminate', due: '', label: '', description: 'Low priority cleanup', subtasks: [] },
          { title: 'Submit quarterly report', quadrant: 'do-first', due: Utils.formatDate(yesterday), label: 'client', description: 'Overdue - needs immediate attention', subtasks: [] }
        ];
        samples.forEach(s => this.store.addTask(s));
      }

      toggleCompletedVisibility() {
        const showCompleted = !this.store.getPref('showCompleted');
        this.store.setPref('showCompleted', showCompleted);
        this.toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';
        this.render();
      }

      closeAuth() {
        this.authBackdrop.classList.remove('show');
        this.authSheet.classList.remove('show');
        this.appArea.style.display = 'block';
      }

      handleAuthSend() {
        alert('Cloud sync is not available in this demo version. Your tasks are saved locally in your browser.');
        this.closeAuth();
      }

      showOnboarding() {
        this.onboard.classList.add('show');
        this.onboard.setAttribute('aria-hidden', 'false');
      }

      closeOnboarding() {
        this.onboard.classList.remove('show');
        this.onboard.setAttribute('aria-hidden', 'true');
        this.store.setPref('onboardingSeen', true);
      }

      handleKeyboard(e) {
        if (e.key === 'Escape') {
          this.closePanel();
          this.closeOnboarding();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
          e.preventDefault();
          if (this.taskTitle) this.taskTitle.focus();
        }
        if (e.key === 'Enter' && (document.activeElement === this.taskTitle || document.activeElement === this.taskDescription || document.activeElement === this.taskDue)) {
          this.handleAddTask();
        }
      }

      async init() {
        this.loadingEl.classList.remove('loading-hidden');
        this.store.load();
        if (!this.store.getPref('onboardingSeen')) {
          setTimeout(() => this.showOnboarding(), 700);
        }
        this.closeAuth();
        this.toggleCompletedBtn.textContent = this.store.getPref('showCompleted') ? 'Hide Completed' : 'Show Completed';
        this.switchView(this.store.getPref('currentView') || 'daily');
        setTimeout(() => {
          this.loadingEl.classList.add('loading-hidden');
          setTimeout(() => this.loadingEl.style.display = 'none', 300);
        }, 500);
      }
    }

    const app = new PrioBoxApp();
    app.init();

    window.priobox = { app, store: app.store, utils: Utils };
  </script>
</body>
</html>
