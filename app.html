<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3TQ4METDYF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3TQ4METDYF');
  </script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0969da" />
  <title>PrioBox â€” Focus What Matters</title>
  <link rel="stylesheet" href="style2.css">
  <meta name="description" content="PrioBox â€” Enhanced productivity app with focus timer, recurring tasks, dark mode, and integrations." />
  <style>
    :root{--bg:#f6f8fa;--panel:#ffffff;--panel-hover:#fafbfc;--border:#d0d7de;--muted:#e1e4e8;--text:#1f2328;--text-secondary:#57606a;--accent-1:#0969da;--accent-2:#0550ae;--accent-light:#ddf4ff;--accent-border:#54aeff;--on-time:#1a7f37;--on-time-bg:#dafbe1;--approach:#bf8700;--approach-bg:#fff8c5;--overdue:#cf222e;--overdue-bg:#ffebe9;--tag-client:#0969da;--tag-client-bg:#ddf4ff;--tag-personal:#8250df;--tag-personal-bg:#fbefff;--tag-urgent:#cf222e;--tag-urgent-bg:#ffebe9;--shadow-sm:rgba(27,31,36,0.04);--shadow-md:rgba(27,31,36,0.08);--shadow-lg:rgba(27,31,36,0.12);--radius:12px;--radius-sm:8px;--radius-lg:16px;--gap:1rem;--ui-h:44px;--transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
    [data-theme="dark"]{--bg:#0d1117;--panel:#161b22;--panel-hover:#1c2128;--border:#30363d;--muted:#21262d;--text:#e6edf3;--text-secondary:#8b949e;--accent-1:#2f81f7;--accent-2:#1f6feb;--accent-light:#1c2d41;--accent-border:#388bfd;--shadow-sm:rgba(1,4,9,0.3);--shadow-md:rgba(1,4,9,0.4);--shadow-lg:rgba(1,4,9,0.5)}
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.5}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:32px;flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center}
    .brand svg{height:48px;width:48px}
    .brand h1{margin:0;font-size:1.5rem;font-weight:700}
    .brand p{margin:0;font-size:0.9rem;color:var(--text-secondary)}
    .header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .icon-btn{height:40px;width:40px;padding:8px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
    .icon-btn:hover{background:var(--panel-hover);border-color:var(--accent-1)}
    .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.95);z-index:9999;font-size:1.1rem;color:var(--text);transition:opacity .3s ease}
    [data-theme="dark"] .loading-overlay{background:rgba(13,17,23,0.95)}
    .loading-hidden{opacity:0;pointer-events:none}
    .view-toggle{display:flex;gap:4px;background:var(--panel);padding:4px;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);flex-wrap:wrap}
    .view-toggle button{padding:10px 20px;border:none;background:transparent;border-radius:24px;cursor:pointer;font-weight:600;font-size:0.95rem;color:var(--text-secondary);transition:0.3s cubic-bezier(0.215,0.61,0.355,1)}
    .view-toggle button:hover{background:var(--panel-hover);color:var(--text)}
    .view-toggle button.active{background:var(--accent-1);color:white;box-shadow:0 2px 8px rgba(39,94,254,0.32)}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin:20px 0}
    .stat-card{background:var(--panel);padding:24px;border-radius:var(--radius);box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);display:flex;flex-direction:column;gap:12px;transition:var(--transition)}
    .stat-card:hover{box-shadow:0 4px 16px var(--shadow-md);transform:translateY(-2px)}
    .stat-value{font-size:2.5rem;font-weight:700;color:var(--accent-1);line-height:1}
    .stat-label{font-size:0.95rem;color:var(--text-secondary);font-weight:500;text-transform:uppercase;letter-spacing:0.05em}
    .daily-hero{background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:white;padding:32px;border-radius:var(--radius-lg);margin:20px 0;box-shadow:0 8px 24px var(--shadow-lg)}
    .daily-hero h2{margin:0 0 8px 0;font-size:2rem;font-weight:700;letter-spacing:-0.02em}
    .daily-hero p{margin:0;opacity:0.95;font-size:1.1rem}
    .focus-list{display:flex;flex-direction:column;gap:12px;margin-top:20px}
    .focus-timer-widget{background:var(--panel);padding:32px;border-radius:var(--radius-lg);margin:20px auto;max-width:600px;box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);text-align:center}
    .timer-display{font-size:4rem;font-weight:700;color:var(--accent-1);margin:24px 0;font-variant-numeric:tabular-nums;letter-spacing:0.05em}
    .timer-controls{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:20px}
    .timer-controls button{padding:12px 28px;border-radius:24px;border:none;background:var(--accent-1);color:white;font-weight:600;cursor:pointer;transition:0.3s cubic-bezier(0.215,0.61,0.355,1);box-shadow:0 2px 8px rgba(39,94,254,0.32)}
    .timer-controls button:hover{transform:scale(1.05)}
    .timer-controls button.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:0 2px 4px var(--shadow-sm)}
    .timer-mode{display:flex;gap:8px;justify-content:center;margin:20px 0;flex-wrap:wrap}
    .timer-mode button{padding:10px 20px;border-radius:20px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-size:0.95rem;transition:var(--transition);color:var(--text);font-weight:500}
    .timer-mode button.active{background:var(--accent-1);color:white;border-color:var(--accent-1)}
    .timer-status{margin-top:16px;font-size:0.95rem;color:var(--text-secondary);font-weight:500}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin:20px 0}
    .controls input[type="text"],.controls input[type="date"],.controls select{height:var(--ui-h);padding:0 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:0.95rem;box-shadow:0 2px 4px var(--shadow-sm);min-width:160px;transition:var(--transition)}
    .controls input:focus,.controls select:focus{outline:none;border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-light)}
    .controls .btn{height:var(--ui-h);padding:0 20px;border-radius:24px;border:none;background:var(--accent-1);color:white;font-weight:600;cursor:pointer;white-space:nowrap;transition:0.3s cubic-bezier(0.215,0.61,0.355,1);box-shadow:0 2px 8px rgba(39,94,254,0.32)}
    .controls .btn:hover{transform:scale(1.05);box-shadow:0 4px 16px rgba(39,94,254,0.48)}
    .controls .btn.ghost{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:0 2px 4px var(--shadow-sm)}
    .controls .btn.ghost:hover{background:var(--panel-hover);border-color:var(--accent-1)}
    .search-row{display:flex;justify-content:center;padding:8px 0}
    .search-row input{width:560px;max-width:100%;height:44px;padding:0 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:0.95rem;transition:var(--transition)}
    .search-row input:focus{outline:none;border-color:var(--accent-1);box-shadow:0 0 0 3px var(--accent-light)}
    .filters{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:8px;flex-wrap:wrap;text-align:center}
    .matrix{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .quadrant{background:var(--panel);border-radius:var(--radius-lg);padding:24px;box-shadow:0 2px 8px var(--shadow-sm);border:1px solid var(--border);min-height:300px;display:flex;flex-direction:column;transition:var(--transition)}
    .quadrant:hover{box-shadow:0 4px 16px var(--shadow-md)}
    .quad-head{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid var(--muted)}
    .quad-title{font-weight:700;font-size:1.1rem;letter-spacing:-0.01em}
    .quad-sub{font-size:0.9rem;color:var(--text-secondary);margin-top:4px;font-weight:500}
    .progress-bar{width:140px;height:6px;background:var(--muted);border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));transition:width .4s cubic-bezier(0.4,0,0.2,1)}
    .tasks{margin-top:12px;display:flex;flex-direction:column;gap:12px;overflow:auto;padding-bottom:8px;flex:1}
    .task{display:flex;gap:12px;align-items:flex-start;background:var(--panel);padding:16px;border-radius:var(--radius);border:1px solid var(--border);cursor:grab;transition:var(--transition);position:relative}
    .task:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow-md);border-color:var(--accent-border)}
    .task.dragging{opacity:0.5;cursor:grabbing}
    .task-left{flex:1;min-width:0}
    .task-title{margin:0;font-weight:600;word-wrap:break-word;font-size:0.95rem;color:var(--text)}
    .task-desc{margin-top:6px;color:var(--text-secondary);font-size:0.9rem;word-wrap:break-word;line-height:1.5}
    .task-due{margin-top:10px;display:inline-block;padding:6px 12px;border-radius:var(--radius-sm);font-weight:600;color:white;font-size:0.85rem}
    .task-controls{display:flex;gap:6px;align-items:center;flex-shrink:0}
    .small-btn{background:transparent;border:none;cursor:pointer;padding:8px;border-radius:var(--radius-sm);font-size:15px;color:var(--text-secondary);transition:var(--transition)}
    .small-btn:hover{background:var(--panel-hover);color:var(--text)}
    .task.completed{opacity:0.5}
    .task.completed .task-title{text-decoration:line-through}
    .task-recurring{border-left:3px solid var(--accent-1)!important}
    .due-on-time{border-left:3px solid var(--on-time);background:var(--on-time-bg)}
    .due-approach{border-left:3px solid var(--approach);background:var(--approach-bg)}
    .due-overdue{border-left:3px solid var(--overdue);background:var(--overdue-bg)}
    .tag{display:inline-block;padding:4px 10px;border-radius:var(--radius-sm);font-weight:600;font-size:0.75rem;margin-left:8px}
    .tag-client{background:var(--tag-client-bg);color:var(--tag-client)}
    .tag-personal{background:var(--tag-personal-bg);color:var(--tag-personal)}
    .tag-urgent{background:var(--tag-urgent-bg);color:var(--tag-urgent)}
    .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
    .empty-state svg{width:80px;height:80px;margin-bottom:16px;opacity:0.5}
    .empty-state h3{margin:16px 0 8px 0;font-size:1.3rem;color:var(--text)}
    .empty-state p{margin:0;font-size:0.95rem}
    footer{text-align:center;color:var(--text-secondary);margin-top:32px;font-size:0.9rem;padding-bottom:20px}
    @media(max-width:900px){.matrix{grid-template-columns:1fr}.controls input[type="text"]{min-width:130px}.timer-display{font-size:2.5rem}}
  </style>
</head>
<body>
  <div id="loading" class="loading-overlay">Loading PrioBox...</div>

  <div class="wrap">
    <header>
      <div class="brand">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <rect x="10" y="10" width="35" height="35" rx="5" fill="#2ea043"/>
          <rect x="55" y="10" width="35" height="35" rx="5" fill="#4caf50"/>
          <rect x="10" y="55" width="35" height="35" rx="5" fill="#66bb6a"/>
          <rect x="55" y="55" width="35" height="35" rx="5" fill="#81c784"/>
        </svg>
        <div>
          <h1>PrioBox</h1>
          <p>Focus what matters</p>
        </div>
      </div>

      <div class="header-actions">
        <button id="themeToggle" class="icon-btn" title="Toggle dark mode">ðŸŒ“</button>
        <button id="templatesBtn" class="icon-btn" title="Task templates">ðŸ“‹</button>
      </div>
    </header>

    <div id="appArea" style="display:none">
      <div style="display:flex;justify-content:center;margin:16px 0">
        <div class="view-toggle">
          <button id="viewDaily" class="active">Daily Focus</button>
          <button id="viewTimer">Focus Timer</button>
          <button id="viewMatrix">Full Matrix</button>
        </div>
      </div>

      <!-- Daily View -->
      <div id="dailyView">
        <div class="daily-hero">
          <h2>Today's Focus</h2>
          <p id="dailyDate"></p>
        </div>
        
        <div id="dailyStats" class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
          <div class="stat-card">
            <div class="stat-value" id="todayDue">0</div>
            <div class="stat-label">Due Today</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="overdueCount">0</div>
            <div class="stat-label">Overdue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="upcomingCount">0</div>
            <div class="stat-label">This Week</div>
          </div>
        </div>

        <div class="focus-list" id="dailyTasks"></div>
      </div>

      <!-- Focus Timer View -->
      <div id="timerView" style="display:none">
        <div class="focus-timer-widget">
          <h2 style="margin:0 0 16px 0">Focus Timer</h2>
          <div class="timer-mode">
            <button id="timerFocus" class="active">Focus (25min)</button>
            <button id="timerShortBreak">Short Break (5min)</button>
            <button id="timerLongBreak">Long Break (15min)</button>
          </div>
          <div class="timer-display" id="timerDisplay">25:00</div>
          <div class="timer-status" id="timerStatus">Ready to focus</div>
          <div class="timer-controls">
            <button id="timerStart">Start</button>
            <button id="timerReset" class="ghost">Reset</button>
          </div>
          <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--muted)">
            <div style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:8px">Sessions completed today: <strong id="sessionsToday">0</strong></div>
          </div>
        </div>
      </div>

      <!-- Matrix View -->
      <div id="matrixView" style="display:none">
        <section class="controls" aria-label="Task controls">
          <input id="taskTitle" type="text" placeholder="Task title (required)" />
          <input id="taskDescription" type="text" placeholder="Description (optional)" />
          <input id="taskDue" type="date" />
          <select id="taskQuadrant">
            <option value="do-first">Do First</option>
            <option value="schedule">Schedule</option>
            <option value="delegate">Delegate</option>
            <option value="eliminate">Eliminate</option>
          </select>
          <button class="btn" id="addBtn">Add Task</button>
          <button class="btn ghost" id="demoBtn">Demo Data</button>
        </section>

        <div class="search-row">
          <input id="searchInput" type="search" placeholder="Search tasks..." />
        </div>

        <div class="filters">
          <button id="toggleCompletedBtn" style="height:36px;padding:8px 12px;border-radius:8px;background:var(--panel);border:1px solid var(--border);cursor:pointer">Hide Completed</button>
        </div>

        <section class="matrix" aria-label="Priority matrix">
          <div class="quadrant do-first" data-q="do-first">
            <div class="quad-head">
              <div><div class="quad-title">Do First</div><div class="quad-sub">Urgent & Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="do-first-count">(0/0 done)</div>
                <div class="progress-bar"><div id="do-first-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="do-first-tasks"></div>
          </div>

          <div class="quadrant schedule" data-q="schedule">
            <div class="quad-head">
              <div><div class="quad-title">Schedule</div><div class="quad-sub">Not Urgent but Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="schedule-count">(0/0 done)</div>
                <div class="progress-bar"><div id="schedule-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="schedule-tasks"></div>
          </div>

          <div class="quadrant delegate" data-q="delegate">
            <div class="quad-head">
              <div><div class="quad-title">Delegate</div><div class="quad-sub">Urgent but Not Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="delegate-count">(0/0 done)</div>
                <div class="progress-bar"><div id="delegate-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="delegate-tasks"></div>
          </div>

          <div class="quadrant eliminate" data-q="eliminate">
            <div class="quad-head">
              <div><div class="quad-title">Eliminate</div><div class="quad-sub">Not Urgent & Not Important</div></div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div id="eliminate-count">(0/0 done)</div>
                <div class="progress-bar"><div id="eliminate-fill" class="progress-fill"></div></div>
              </div>
            </div>
            <div class="tasks" id="eliminate-tasks"></div>
          </div>
        </section>
      </div>

      <footer>Â© 2025 PrioBox â€” Built by DGS Consulting</footer>
    </div>
  </div>

  <script>
    'use strict';

    console.log('Script starting...');

    // Task Store
    class TaskStore {
      constructor() {
        this.STORAGE_KEY = 'priobox_tasks_v3';
        this.PREFS_KEY = 'priobox_prefs_v3';
        this.tasks = {};
        this.prefs = { 
          showCompleted: true, 
          theme: 'light', 
          currentView: 'daily',
          timerSessions: 0,
          timerSessionsDate: new Date().toDateString()
        };
        this.listeners = [];
        console.log('TaskStore initialized');
      }

      load() {
        try {
          const rawTasks = localStorage.getItem(this.STORAGE_KEY);
          const rawPrefs = localStorage.getItem(this.PREFS_KEY);
          
          if (rawTasks) {
            const data = JSON.parse(rawTasks);
            this.tasks = data.tasks || {};
          }
          
          if (rawPrefs) {
            this.prefs = { ...this.prefs, ...JSON.parse(rawPrefs) };
          }
          
          console.log('Loaded tasks:', Object.keys(this.tasks).length);
        } catch(e) { 
          console.error('Load error:', e); 
        }
      }

      save() {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ tasks: this.tasks }));
          this.notify();
        } catch(e) { console.error('Save error:', e); }
      }

      savePrefs() {
        try {
          localStorage.setItem(this.PREFS_KEY, JSON.stringify(this.prefs));
        } catch(e) { console.error('Save prefs error:', e); }
      }

      subscribe(callback) {
        this.listeners.push(callback);
      }

      notify() { 
        this.listeners.forEach(cb => cb()); 
      }

      addTask(task) {
        const id = `t-${Date.now()}-${Math.floor(Math.random() * 9000 + 1000)}`;
        this.tasks[id] = { 
          id, 
          title: task.title || 'Untitled', 
          description: task.description || '', 
          due: task.due || '', 
          quadrant: task.quadrant || 'do-first', 
          completed: false, 
          createdAt: Date.now()
        };
        this.save();
        return id;
      }

      updateTask(id, updates) {
        if (!this.tasks[id]) return false;
        this.tasks[id] = { ...this.tasks[id], ...updates };
        this.save();
        return true;
      }

      deleteTask(id) {
        if (!this.tasks[id]) return false;
        delete this.tasks[id];
        this.save();
        return true;
      }

      getAllTasks() { return Object.values(this.tasks); }
      getTasksByQuadrant(quadrant) { return this.getAllTasks().filter(t => t.quadrant === quadrant); }

      toggleComplete(id) {
        const task = this.tasks[id];
        if (!task) return false;
        task.completed = !task.completed;
        this.save();
        return true;
      }

      setPref(key, value) { this.prefs[key] = value; this.savePrefs(); }
      getPref(key) { return this.prefs[key]; }

      incrementTimerSessions() {
        this.prefs.timerSessions++;
        this.savePrefs();
        this.notify();
      }
    }

    // Utility functions
    const Utils = {
      escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },
      formatDate(dateStr) {
        if (!dateStr) return '';
        try { return new Date(dateStr).toISOString().slice(0, 10); } catch { return dateStr; }
      },
      getDaysDiff(dateStr) {
        if (!dateStr) return null;
        const today = new Date(); today.setHours(0,0,0,0);
        const date = new Date(dateStr); date.setHours(0,0,0,0);
        return Math.round((date - today) / (1000 * 60 * 60 * 24));
      },
      getUrgencyClass(dateStr) {
        const diff = this.getDaysDiff(dateStr);
        if (diff === null) return '';
        if (diff < 0) return 'due-overdue';
        if (diff <= 2) return 'due-approach';
        return 'due-on-time';
      },
      debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), wait);
        };
      },
      formatDateFull(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }
    };

    // Focus Timer
    class FocusTimer {
      constructor(store) {
        this.store = store;
        this.modes = { focus: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60 };
        this.currentMode = 'focus';
        this.timeLeft = this.modes.focus;
        this.isRunning = false;
        this.interval = null;
        console.log('FocusTimer initialized');
      }

      setMode(mode) {
        this.currentMode = mode;
        this.timeLeft = this.modes[mode];
        this.isRunning = false;
        if (this.interval) clearInterval(this.interval);
        this.updateDisplay();
      }

      start() {
        this.isRunning = true;
        this.interval = setInterval(() => {
          this.timeLeft--;
          this.updateDisplay();
          if (this.timeLeft <= 0) {
            this.complete();
          }
        }, 1000);
        this.updateDisplay();
      }

      pause() {
        this.isRunning = false;
        if (this.interval) clearInterval(this.interval);
        this.updateDisplay();
      }

      reset() {
        this.isRunning = false;
        if (this.interval) clearInterval(this.interval);
        this.timeLeft = this.modes[this.currentMode];
        this.updateDisplay();
      }

      complete() {
        this.pause();
        if (this.currentMode === 'focus') {
          this.store.incrementTimerSessions();
        }
        alert(`${this.currentMode === 'focus' ? 'Focus' : 'Break'} complete!`);
      }

      updateDisplay() {
        const mins = Math.floor(this.timeLeft / 60);
        const secs = this.timeLeft % 60;
        const display = document.getElementById('timerDisplay');
        const status = document.getElementById('timerStatus');
        const startBtn = document.getElementById('timerStart');
        const sessions = document.getElementById('sessionsToday');
        
        if (display) display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        if (status) status.textContent = this.isRunning ? 'Focus time...' : 'Paused';
        if (startBtn) startBtn.textContent = this.isRunning ? 'Pause' : 'Start';
        if (sessions) sessions.textContent = this.store.getPref('timerSessions') || 0;
      }
    }

    // Task Renderer
    class TaskRenderer {
      constructor(store) {
        this.store = store;
        this.searchTerm = '';
      }
      
      setSearchTerm(term) { 
        this.searchTerm = term.toLowerCase().trim(); 
      }
      
      matchesSearch(task) {
        if (!this.searchTerm) return true;
        const searchStr = (task.title + ' ' + (task.description || '') + ' ' + (task.due || '')).toLowerCase();
        return searchStr.includes(this.searchTerm);
      }
      
      createTaskElement(task) {
        const div = document.createElement('div');
        div.className = 'task'; 
        div.dataset.id = task.id;
        if (task.completed) div.classList.add('completed');
        const urgencyClass = Utils.getUrgencyClass(task.due);
        if (urgencyClass) div.classList.add(urgencyClass);
        
        const left = document.createElement('div'); 
        left.className = 'task-left';
        
        let contentHtml = `<div class="task-title">${Utils.escapeHtml(task.title)}</div>`;
        if (task.description) {
          contentHtml += `<div class="task-desc">${Utils.escapeHtml(task.description)}</div>`;
        }
        if (task.due) {
          contentHtml += `<div class="task-due">${Utils.escapeHtml(task.due)}</div>`;
        }
        left.innerHTML = contentHtml;
        
        const controls = document.createElement('div'); 
        controls.className = 'task-controls';
        controls.appendChild(this.createButton(
          task.completed ? 'â†º' : 'âœ”', 
          task.completed ? 'Mark incomplete' : 'Mark complete', 
          () => app.toggleComplete(task.id)
        ));
        controls.appendChild(this.createButton(
          'âœ•', 
          'Delete', 
          () => app.deleteTask(task.id)
        ));
        
        div.appendChild(controls); 
        div.appendChild(left);
        this.setupDrag(div);
        return div;
      }
      
      createButton(text, title, onClick) {
        const btn = document.createElement('button');
        btn.className = 'small-btn'; 
        btn.textContent = text; 
        btn.title = title;
        btn.onclick = (e) => { 
          e.stopPropagation(); 
          onClick(); 
        };
        return btn;
      }
      
      setupDrag(element) {
        element.draggable = true;
        element.addEventListener('dragstart', (e) => { 
          element.classList.add('dragging'); 
          e.dataTransfer.effectAllowed = 'move'; 
          e.dataTransfer.setData('text/plain', element.dataset.id); 
        });
        element.addEventListener('dragend', () => { 
          element.classList.remove('dragging'); 
        });
      }
    }

    // Main App
    class PrioBoxApp {
      constructor() {
        console.log('App constructor starting...');
        this.store = new TaskStore();
        this.renderer = new TaskRenderer(this.store);
        this.timer = new FocusTimer(this.store);
        this.currentView = 'daily';
        this.quadrants = ['do-first', 'schedule', 'delegate', 'eliminate'];
        this.initializeElements();
        this.setupEventListeners();
        this.store.subscribe(() => this.render());
        console.log('App constructor complete');
      }

      initializeElements() {
        console.log('Initializing elements...');
        this.loadingEl = document.getElementById('loading');
        this.appArea = document.getElementById('appArea');
        this.themeToggle = document.getElementById('themeToggle');
        this.templatesBtn = document.getElementById('templatesBtn');
        this.viewDaily = document.getElementById('viewDaily');
        this.viewMatrix = document.getElementById('viewMatrix');
        this.viewTimer = document.getElementById('viewTimer');
        this.dailyView = document.getElementById('dailyView');
        this.matrixView = document.getElementById('matrixView');
        this.timerView = document.getElementById('timerView');
        this.addBtn = document.getElementById('addBtn');
        this.demoBtn = document.getElementById('demoBtn');
        this.taskTitle = document.getElementById('taskTitle');
        this.taskDescription = document.getElementById('taskDescription');
        this.taskDue = document.getElementById('taskDue');
        this.taskQuadrant = document.getElementById('taskQuadrant');
        this.searchInput = document.getElementById('searchInput');
        this.toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
        console.log('Elements initialized');
      }

      setupEventListeners() {
        console.log('Setting up event listeners...');
        
        if (this.themeToggle) {
          this.themeToggle.addEventListener('click', () => this.toggleTheme());
        }
        
        if (this.viewDaily) {
          this.viewDaily.addEventListener('click', () => this.switchView('daily'));
        }
        if (this.viewMatrix) {
          this.viewMatrix.addEventListener('click', () => this.switchView('matrix'));
        }
        if (this.viewTimer) {
          this.viewTimer.addEventListener('click', () => this.switchView('timer'));
        }
        
        if (this.addBtn) {
          this.addBtn.addEventListener('click', () => this.handleAddTask());
        }
        if (this.demoBtn) {
          this.demoBtn.addEventListener('click', () => this.loadDemoData());
        }
        
        if (this.searchInput) {
          this.searchInput.addEventListener('input', Utils.debounce(() => { 
            this.renderer.setSearchTerm(this.searchInput.value); 
            this.render(); 
          }, 300));
        }
        
        if (this.toggleCompletedBtn) {
          this.toggleCompletedBtn.addEventListener('click', () => this.toggleCompletedVisibility());
        }
        
        // Timer controls
        const timerFocus = document.getElementById('timerFocus');
        const timerShortBreak = document.getElementById('timerShortBreak');
        const timerLongBreak = document.getElementById('timerLongBreak');
        const timerStart = document.getElementById('timerStart');
        const timerReset = document.getElementById('timerReset');
        
        if (timerFocus) {
          timerFocus.addEventListener('click', () => { 
            this.timer.setMode('focus'); 
            this.updateTimerModeButtons('focus'); 
          });
        }
        if (timerShortBreak) {
          timerShortBreak.addEventListener('click', () => { 
            this.timer.setMode('shortBreak'); 
            this.updateTimerModeButtons('shortBreak'); 
          });
        }
        if (timerLongBreak) {
          timerLongBreak.addEventListener('click', () => { 
            this.timer.setMode('longBreak'); 
            this.updateTimerModeButtons('longBreak'); 
          });
        }
        if (timerStart) {
          timerStart.addEventListener('click', () => { 
            this.timer.isRunning ? this.timer.pause() : this.timer.start(); 
          });
        }
        if (timerReset) {
          timerReset.addEventListener('click', () => this.timer.reset());
        }

        this.setupDragTargets();
        console.log('Event listeners set up');
      }

      setupDragTargets() {
        document.querySelectorAll('.quadrant').forEach(qEl => {
          qEl.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            qEl.style.background = 'rgba(46, 160, 67, 0.05)'; 
          });
          qEl.addEventListener('dragleave', () => { 
            qEl.style.background = ''; 
          });
          qEl.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            qEl.style.background = ''; 
            const taskId = e.dataTransfer.getData('text/plain'); 
            const targetQuadrant = qEl.dataset.q; 
            if (taskId && targetQuadrant) {
              this.store.updateTask(taskId, { quadrant: targetQuadrant }); 
            }
          });
        });
      }

      toggleTheme() {
        const current = this.store.getPref('theme') || 'light';
        const newTheme = current === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        this.store.setPref('theme', newTheme);
      }

      updateTimerModeButtons(mode) {
        ['timerFocus', 'timerShortBreak', 'timerLongBreak'].forEach(id => {
          const btn = document.getElementById(id);
          if (btn) btn.classList.remove('active');
        });
        const modeMap = { focus: 'timerFocus', shortBreak: 'timerShortBreak', longBreak: 'timerLongBreak' };
        const activeBtn = document.getElementById(modeMap[mode]);
        if (activeBtn) activeBtn.classList.add('active');
      }

      switchView(view) {
        console.log('Switching to view:', view);
        this.currentView = view;
        this.store.setPref('currentView', view);
        
        [this.viewDaily, this.viewMatrix, this.viewTimer].forEach(btn => {
          if (btn) btn.classList.remove('active');
        });
        
        if (this.dailyView) this.dailyView.style.display = 'none';
        if (this.matrixView) this.matrixView.style.display = 'none';
        if (this.timerView) this.timerView.style.display = 'none';
        
        if (view === 'daily') { 
          if (this.viewDaily) this.viewDaily.classList.add('active'); 
          if (this.dailyView) this.dailyView.style.display = 'block'; 
          this.renderDailyView(); 
        }
        else if (view === 'matrix') { 
          if (this.viewMatrix) this.viewMatrix.classList.add('active'); 
          if (this.matrixView) this.matrixView.style.display = 'block'; 
          this.renderMatrixView(); 
        }
        else if (view === 'timer') { 
          if (this.viewTimer) this.viewTimer.classList.add('active'); 
          if (this.timerView) this.timerView.style.display = 'block'; 
          this.timer.updateDisplay(); 
        }
      }

      render() {
        if (this.currentView === 'daily') this.renderDailyView();
        else if (this.currentView === 'matrix') this.renderMatrixView();
        else if (this.currentView === 'timer') this.timer.updateDisplay();
      }

      renderDailyView() {
        const today = new Date();
        const dailyDate = document.getElementById('dailyDate');
        if (dailyDate) {
          dailyDate.textContent = Utils.formatDateFull(today);
        }
        
        const allTasks = this.store.getAllTasks();
        const todayTasks = allTasks.filter(t => { 
          const diff = Utils.getDaysDiff(t.due); 
          return diff === 0 && !t.completed; 
        });
        const overdueTasks = allTasks.filter(t => { 
          const diff = Utils.getDaysDiff(t.due); 
          return diff !== null && diff < 0 && !t.completed; 
        });
        const upcomingTasks = allTasks.filter(t => { 
          const diff = Utils.getDaysDiff(t.due); 
          return diff !== null && diff > 0 && diff <= 7 && !t.completed; 
        });
        
        const todayDueEl = document.getElementById('todayDue');
        const overdueCountEl = document.getElementById('overdueCount');
        const upcomingCountEl = document.getElementById('upcomingCount');
        
        if (todayDueEl) todayDueEl.textContent = todayTasks.length;
        if (overdueCountEl) overdueCountEl.textContent = overdueTasks.length;
        if (upcomingCountEl) upcomingCountEl.textContent = upcomingTasks.length;
        
        const container = document.getElementById('dailyTasks');
        if (container) {
          container.innerHTML = '';
          if (overdueTasks.length > 0) this.renderTaskSection(container, 'Overdue', overdueTasks, 'var(--overdue)');
          if (todayTasks.length > 0) this.renderTaskSection(container, 'Due Today', todayTasks, 'var(--accent-1)');
          if (upcomingTasks.length > 0) this.renderTaskSection(container, 'This Week', upcomingTasks, 'var(--approach)');
          
          if (overdueTasks.length === 0 && todayTasks.length === 0 && upcomingTasks.length === 0) {
            container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="10" width="35" height="35" rx="5" fill="currentColor"/><rect x="55" y="10" width="35" height="35" rx="5" fill="currentColor"/><rect x="10" y="55" width="35" height="35" rx="5" fill="currentColor"/><rect x="55" y="55" width="35" height="35" rx="5" fill="currentColor"/></svg><h3>All caught up!</h3><p>No urgent tasks. Great job staying organized.</p></div>';
          }
        }
      }

      renderTaskSection(container, title, tasks, color) {
        const section = document.createElement('div');
        section.innerHTML = `<h3 style="color:${color};margin:16px 0 8px 0">${title}</h3>`;
        container.appendChild(section);
        tasks.sort((a, b) => { 
          if (a.due && b.due) return new Date(a.due) - new Date(b.due); 
          return 0; 
        }).forEach(task => { 
          container.appendChild(this.renderer.createTaskElement(task)); 
        });
      }

      renderMatrixView() {
        this.quadrants.forEach(q => {
          const container = document.getElementById(`${q}-tasks`);
          if (!container) return;
          container.innerHTML = '';
          const tasks = this.store.getTasksByQuadrant(q);
          tasks.sort((a, b) => { 
            if (a.due && b.due) return new Date(a.due) - new Date(b.due); 
            if (a.due) return -1; 
            if (b.due) return 1; 
            return (a.createdAt || 0) - (b.createdAt || 0); 
          });
          tasks.forEach(task => {
            if (!this.renderer.matchesSearch(task)) return;
            const node = this.renderer.createTaskElement(task);
            if (!this.store.getPref('showCompleted') && task.completed) {
              node.style.display = 'none';
            }
            container.appendChild(node);
          });
        });
        this.updateQuadrantStats();
      }

      updateQuadrantStats() {
        this.quadrants.forEach(q => {
          const tasks = this.store.getTasksByQuadrant(q);
          const total = tasks.length;
          const done = tasks.filter(t => t.completed).length;
          const pct = total === 0 ? 0 : Math.round((done / total) * 100);
          const countEl = document.getElementById(`${q}-count`);
          const fillEl = document.getElementById(`${q}-fill`);
          if (countEl) countEl.textContent = `(${done}/${total} done)`;
          if (fillEl) fillEl.style.width = pct + '%';
        });
      }

      handleAddTask() {
        const title = this.taskTitle.value.trim();
        if (!title) { 
          if (this.taskTitle) this.taskTitle.focus(); 
          return; 
        }
        this.store.addTask({ 
          title, 
          description: this.taskDescription ? this.taskDescription.value.trim() : '', 
          due: this.taskDue ? this.taskDue.value || '' : '', 
          quadrant: this.taskQuadrant ? this.taskQuadrant.value || 'do-first' : 'do-first'
        });
        if (this.taskTitle) this.taskTitle.value = ''; 
        if (this.taskDescription) this.taskDescription.value = ''; 
        if (this.taskDue) this.taskDue.value = ''; 
        if (this.taskQuadrant) this.taskQuadrant.value = 'do-first';
      }

      toggleComplete(taskId) { 
        this.store.toggleComplete(taskId); 
      }
      
      deleteTask(taskId) { 
        if (!confirm('Delete this task?')) return; 
        this.store.deleteTask(taskId); 
      }

      loadDemoData() {
        if (Object.keys(this.store.tasks).length > 0) {
          if (!confirm('This will add demo tasks. Continue?')) return;
        }
        
        const today = new Date();
        const tomorrow = new Date(today.getTime() + 86400000);
        const nextWeek = new Date(today.getTime() + 7 * 86400000);
        const yesterday = new Date(today.getTime() - 86400000);
        
        const samples = [
          { title: 'Fix critical signup bug', quadrant: 'do-first', due: Utils.formatDate(tomorrow), description: 'Users cannot complete registration' },
          { title: 'Plan Q2 roadmap', quadrant: 'schedule', due: Utils.formatDate(nextWeek), description: 'Strategic planning session with team' },
          { title: 'Review social media posts', quadrant: 'delegate', due: '', description: 'Quick 15-minute task' },
          { title: 'Clean old email subscriptions', quadrant: 'eliminate', due: '', description: 'Low priority cleanup' },
          { title: 'Submit quarterly report', quadrant: 'do-first', due: Utils.formatDate(yesterday), description: 'Overdue - needs immediate attention' }
        ];
        samples.forEach(s => this.store.addTask(s));
      }

      toggleCompletedVisibility() {
        const showCompleted = !this.store.getPref('showCompleted');
        this.store.setPref('showCompleted', showCompleted);
        if (this.toggleCompletedBtn) {
          this.toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';
        }
        this.render();
      }

      async init() {
        console.log('Initializing app...');
        if (this.loadingEl) {
          this.loadingEl.classList.remove('loading-hidden');
        }
        
        this.store.load();
        
        const theme = this.store.getPref('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        
        if (this.appArea) {
          this.appArea.style.display = 'block';
        }
        
        if (this.toggleCompletedBtn) {
          this.toggleCompletedBtn.textContent = this.store.getPref('showCompleted') ? 'Hide Completed' : 'Show Completed';
        }
        
        this.switchView(this.store.getPref('currentView') || 'daily');
        
        setTimeout(() => {
          if (this.loadingEl) {
            this.loadingEl.classList.add('loading-hidden');
            setTimeout(() => {
              if (this.loadingEl) {
                this.loadingEl.style.display = 'none';
              }
            }, 300);
          }
        }, 500);
        
        console.log('App initialized successfully');
      }
    }

    // Initialize app
    try {
      console.log('Creating app instance...');
      const app = new PrioBoxApp();
      app.init();
      window.priobox = { app, store: app.store, utils: Utils, timer: app.timer };
      console.log('App ready!');
    } catch (error) {
      console.error('Error initializing app:', error);
      alert('Error loading PrioBox. Please check the console for details.');
    }
  </script>
</body>
</html>
