<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrioBox ‚Äî Focus What Matters</title>
  <meta name="description" content="PrioBox ‚Äî Eisenhower priority matrix with due dates, labels, calendar export and cloud sync." />
  <meta property="og:image" content="images/hero-illustration.svg" />
  <style>
    :root{
      --bg: #f8f7f4;           /* chosen off-white */
      --panel: #ffffff;
      --muted: #d9d9d6;
      --text: #163818;
      --accent-1: #2ea043;
      --accent-2: #238636;
      --on-time: #a7c4a0;
      --approach: #e0b86b;
      --overdue:  #d97a6d;
      --tag-client: #7ad3c9;
      --tag-personal: #f7d07a;
      --tag-urgent: #ff9c8a;
      --shadow: rgba(0,0,0,0.08);
      --radius: 10px;
      --gap: 1rem;
      --ui-h: 44px;
    }

    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:56px;height:56px;border-radius:12px;padding:6px;background:var(--panel);box-shadow:0 8px 26px var(--shadow)}
    .brand h1{font-size:1.2rem;margin:0}
    .brand p{margin:0;font-size:0.85rem;color:#4f6b51}

    /* Auth card (branded) */
    .auth-card{width:100%;max-width:520px;margin:20px auto 10px;padding:18px;border-radius:12px;background:var(--panel);box-shadow:0 20px 50px rgba(0,0,0,0.08);display:flex;flex-direction:column;gap:12px}
    .auth-row{display:flex;gap:8px;align-items:center}
    .auth-row input{flex:1;height:44px;padding:8px 12px;border-radius:10px;border:1px solid var(--muted);background:var(--panel)}
    .auth-row button{height:44px;padding:0 14px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
    .auth-note{font-size:0.9rem;color:#546b52}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:12px 0}
    .controls input[type="text"], .controls input[type="date"], .controls select { height:var(--ui-h); padding:8px 12px; border-radius:10px; border:1px solid var(--muted); background:var(--panel); font-size:0.95rem; box-shadow:0 8px 20px var(--shadow) }
    .controls .btn{ height:var(--ui-h); padding:0 14px; border-radius:10px; border:none; background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); color:white; font-weight:700; cursor:pointer }
    .controls .btn.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--text) }

    .search-row{display:flex;justify-content:center;padding:6px 0}
    .search-row input{width:520px;max-width:100%;height:42px;padding:8px 12px;border-radius:10px;border:1px solid var(--muted);background:var(--panel)}

    .filters{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:8px}

    /* Matrix */
    .matrix{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);}
    .quadrant{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:0 12px 34px var(--shadow);min-height:260px;display:flex;flex-direction:column}
    .quad-head{display:flex;justify-content:space-between;align-items:center}
    .quad-title{font-weight:800}
    .quad-sub{font-size:0.88rem;color:#6b6b64;margin-top:6px}
    .progress-bar{width:140px;height:8px;background:#f0f0ee;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));transition:width .28s ease}

    .tasks{margin-top:10px;display:flex;flex-direction:column;gap:10px;overflow:auto;padding-bottom:6px}

    /* Task */
    .task{display:flex;gap:12px;align-items:flex-start;background:linear-gradient(180deg,#fff,#fbfbfb);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:grab;transition:transform .14s ease,box-shadow .14s ease,opacity .18s ease}
    .task:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(0,0,0,0.06)}
    .task-left{flex:1}
    .task-title{margin:0;font-weight:700}
    .task-desc{margin-top:6px;color:#596c56;font-size:0.88rem}
    .task-due{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;color:white;font-size:0.82rem}
    .task-controls{display:flex;gap:8px;align-items:center}
    .small-btn{background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px;font-size:14px}

    .task.completed{opacity:0.6;text-decoration:line-through}

    .due-on-time{border-left:4px solid var(--on-time);background:linear-gradient(90deg, rgba(167,196,160,0.12), transparent)}
    .due-approach{border-left:4px solid var(--approach);background:linear-gradient(90deg, rgba(224,184,107,0.10), transparent)}
    .due-overdue{border-left:4px solid var(--overdue);background:linear-gradient(90deg, rgba(217,122,109,0.10), transparent)}

    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.75rem;margin-left:6px}
    .tag-client{background:var(--tag-client);color:#064542}
    .tag-personal{background:var(--tag-personal);color:#5a3f00}
    .tag-urgent{background:var(--tag-urgent);color:#6b1f10}

    /* slide-out panel */
    .panel-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.25);display:none;z-index:120}
    .panel{position:fixed;right:0;top:0;height:100%;width:420px;max-width:94%;background:var(--panel);box-shadow:-20px 0 60px rgba(0,0,0,0.3);transform:translateX(108%);transition:transform .28s ease;z-index:130;padding:18px;display:flex;flex-direction:column;gap:12px}
    .panel.show{transform:translateX(0)}
    .panel-backdrop.show{display:block}

    .panel input[type="text"],.panel input[type="date"],.panel select,.panel textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--muted);background:var(--panel)}
    .panel textarea{min-height:100px;resize:vertical}

    /* onboarding */
    .onboard{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:140;pointer-events:none;opacity:0}
    .onboard.show{pointer-events:auto;opacity:1}
    .onboard-card{background:var(--panel);padding:20px;border-radius:12px;width:min(760px,94%);box-shadow:0 30px 70px rgba(0,0,0,0.28)}

    footer{text-align:center;color:#557a5a;margin-top:12px;font-size:0.9rem}

    @media(max-width:900px){.matrix{grid-template-columns:1fr}.controls input[type="text"]{min-width:130px}.panel{width:100%}}
  </style>

  <!-- Supabase client library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/bundle.min.js"></script>
</head>
<body>
  <div class="wrap" id="root">
    <header>
      <div class="brand">
        <a href="index.html" style="text-decoration:none;color:inherit"><img src="images/PrioBox - Icon.png" alt="PrioBox logo"></a>
        <div>
          <h1>PrioBox</h1>
          <p>Focus what matters with PrioBox</p>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="signOutBtn" style="display:none;height:40px;padding:8px;border-radius:10px;background:var(--panel);border:1px solid rgba(0,0,0,0.06);cursor:pointer">Sign Out</button>
        <button id="accountBtn" style="display:none;height:40px;padding:8px;border-radius:10px;background:var(--panel);border:1px solid rgba(0,0,0,0.06);cursor:pointer">Account</button>
      </div>
    </header>

    <!-- Branded auth card: shown until signed in -->
    <div id="authCard" class="auth-card" aria-hidden="false">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="images/PrioBox - Icon.png" alt="logo" style="width:56px;height:56px;border-radius:12px;padding:6px;background:var(--panel)">
        <div>
          <h2 style="margin:0">Welcome to PrioBox</h2>
          <div style="margin-top:6px;color:#546b52">Focus what matters ‚Äî get started quickly with a magic link.</div>
        </div>
      </div>

      <div class="auth-row">
        <input id="emailInput" type="email" placeholder="Your email" aria-label="email" />
        <button id="magicBtn">Send Magic Link</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="auth-note">We‚Äôll email a link ‚Äî no password required.</div>
        <div style="display:flex;gap:8px">
          <button id="demoBtn" class="btn ghost">Use Demo Data</button>
        </div>
      </div>
    </div>

    <!-- App content (hidden until signed in) -->
    <div id="appArea" style="display:none">
      <!-- Controls -->
      <section class="controls" aria-label="Task controls">
        <input id="taskTitle" type="text" placeholder="Task title (required)" />
        <input id="taskDescription" type="text" placeholder="Description (optional)" />
        <input id="taskDue" type="date" />
        <select id="taskQuadrant">
          <option value="do-first">Do First</option>
          <option value="schedule">Schedule</option>
          <option value="delegate">Delegate</option>
          <option value="eliminate">Eliminate</option>
        </select>
        <select id="taskLabel">
          <option value="">No label</option>
          <option value="client">Client</option>
          <option value="personal">Personal</option>
          <option value="urgent">Urgent</option>
        </select>
        <button class="btn" id="addBtn">Add Task</button>
        <button class="btn ghost" id="clearBtn">Clear All</button>
      </section>

      <div class="search-row">
        <input id="searchInput" type="search" placeholder="Search tasks by title, description, due date, label..." />
      </div>

      <div class="filters">
        <button id="toggleCompletedBtn" style="height:36px;padding:8px;border-radius:8px;background:var(--panel);border:1px solid rgba(0,0,0,0.06);cursor:pointer">Hide Completed</button>
        <div style="font-size:0.9rem;color:#4f6b51">Double-click to edit ‚Ä¢ Drag between quadrants</div>
      </div>

      <!-- Matrix -->
      <section class="matrix" aria-label="Priority matrix">
        <div class="quadrant do-first" data-q="do-first">
          <div class="quad-head">
            <div><div class="quad-title">üö® Do First</div><div class="quad-sub">High impact ‚Ä¢ Low effort</div></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
              <div id="do-first-count">(0/0 done)</div>
              <div class="progress-bar"><div id="do-first-fill" class="progress-fill"></div></div>
            </div>
          </div>
          <div class="tasks" id="do-first-tasks" aria-live="polite"></div>
        </div>

        <div class="quadrant schedule" data-q="schedule">
          <div class="quad-head">
            <div><div class="quad-title">üìÖ Schedule</div><div class="quad-sub">High impact ‚Ä¢ High effort</div></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
              <div id="schedule-count">(0/0 done)</div>
              <div class="progress-bar"><div id="schedule-fill" class="progress-fill"></div></div>
            </div>
          </div>
          <div class="tasks" id="schedule-tasks"></div>
        </div>

        <div class="quadrant delegate" data-q="delegate">
          <div class="quad-head">
            <div><div class="quad-title">üë• Delegate</div><div class="quad-sub">Low impact ‚Ä¢ Low effort</div></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
              <div id="delegate-count">(0/0 done)</div>
              <div class="progress-bar"><div id="delegate-fill" class="progress-fill"></div></div>
            </div>
          </div>
          <div class="tasks" id="delegate-tasks"></div>
        </div>

        <div class="quadrant eliminate" data-q="eliminate">
          <div class="quad-head">
            <div><div class="quad-title">üóëÔ∏è Eliminate</div><div class="quad-sub">Low impact ‚Ä¢ High effort</div></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
              <div id="eliminate-count">(0/0 done)</div>
              <div class="progress-bar"><div id="eliminate-fill" class="progress-fill"></div></div>
            </div>
          </div>
          <div class="tasks" id="eliminate-tasks"></div>
        </div>
      </section>

      <footer style="text-align:center;color:#557a5a;margin-top:12px">¬© 2025 PrioBox ‚Äî Built by DGS Consulting</footer>
    </div>
  </div>

  <!-- Slide-out edit panel -->
  <div id="panelBackdrop" class="panel-backdrop"></div>
  <aside id="slidePanel" class="panel" role="dialog" aria-hidden="true">
    <h3 id="panelTitle">Edit task</h3>
    <div class="row">
      <input id="pTitle" type="text" placeholder="Task title" />
    </div>
    <div class="row">
      <input id="pDue" type="date" />
      <select id="pQuadrant">
        <option value="do-first">Do First</option>
        <option value="schedule">Schedule</option>
        <option value="delegate">Delegate</option>
        <option value="eliminate">Eliminate</option>
      </select>
    </div>
    <div class="row">
      <select id="pLabel">
        <option value="">No label</option>
        <option value="client">Client</option>
        <option value="personal">Personal</option>
        <option value="urgent">Urgent</option>
      </select>
      <label style="display:flex;align-items:center;gap:8px"><input id="pCompleted" type="checkbox"> Completed</label>
    </div>
    <div class="row">
      <textarea id="pDesc" placeholder="Description"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="panelCancel" class="btn ghost">Cancel</button>
      <button id="panelSave" class="btn">Save</button>
    </div>

    <hr />
    <div style="display:flex;gap:8px;flex-direction:column">
      <button id="addToCalendarBtn" class="btn ghost">Open Google Calendar</button>
      <button id="downloadICSBtn" class="btn ghost">Download .ics</button>
      <button id="deleteFromPanelBtn" class="btn ghost" style="color:#b33">Delete Task</button>
    </div>
  </aside>

  <!-- onboarding -->
  <div id="onboard" class="onboard" aria-hidden="true">
    <div class="onboard-card">
      <h2>Welcome to PrioBox</h2>
      <p>3 quick tips:</p>
      <ol>
        <li>Add a task with a due date and optionally a label (Client / Personal / Urgent).</li>
        <li>Drag tasks between quadrants to reprioritize.</li>
        <li>Use the slide-out panel to edit, mark complete, export to calendar, or delete.</li>
      </ol>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="onboardSkip" class="btn ghost">Skip</button>
        <button id="onboardDone" class="btn">Got it</button>
      </div>
    </div>
  </div>

  <input id="importFileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // ---------------- Supabase config (from you)
    const SUPABASE_URL = 'https://ppakzbnmqjoxiyijboob.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwYWt6Ym5tcWpveGl5aWpib29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjk3MjMsImV4cCI6MjA3ODYwNTcyM30.NgTuxA3osuTz0xB3o5XIryKyPBJ6tBukVwLW71OSl40';

    // Create Supabase client (global 'supabase' provided by CDN)
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---------------- State
    const STORAGE_KEY = 'priobox_v4_tasks';
    const PREFS_KEY = 'priobox_v4_prefs';
    let tasks = {}; // id => task
    let prefs = JSON.parse(localStorage.getItem(PREFS_KEY) || '{}');
    if (prefs.showCompleted === undefined) prefs.showCompleted = true;
    if (!prefs.theme) prefs.theme = 'light';

    let currentUser = null;
    let editingId = null;
    let dragged = null;
    const quadrants = ['do-first','schedule','delegate','eliminate'];

    // ---------------- DOM refs
    const authCard = document.getElementById('authCard');
    const emailInput = document.getElementById('emailInput');
    const magicBtn = document.getElementById('magicBtn');
    const demoBtn = document.getElementById('demoBtn');

    const appArea = document.getElementById('appArea');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const taskTitle = document.getElementById('taskTitle');
    const taskDesc = document.getElementById('taskDescription');
    const taskDue = document.getElementById('taskDue');
    const taskQuadrant = document.getElementById('taskQuadrant');
    const taskLabel = document.getElementById('taskLabel');
    const searchInput = document.getElementById('searchInput');
    const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const accountBtn = document.getElementById('accountBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileInput = document.getElementById('importFileInput');

    const panelBackdrop = document.getElementById('panelBackdrop');
    const slidePanel = document.getElementById('slidePanel');
    const pTitle = document.getElementById('pTitle');
    const pDesc = document.getElementById('pDesc');
    const pDue = document.getElementById('pDue');
    const pQuadrant = document.getElementById('pQuadrant');
    const pLabel = document.getElementById('pLabel');
    const pCompleted = document.getElementById('pCompleted');
    const panelSave = document.getElementById('panelSave');
    const panelCancel = document.getElementById('panelCancel');
    const addToCalendarBtn = document.getElementById('addToCalendarBtn');
    const downloadICSBtn = document.getElementById('downloadICSBtn');
    const deleteFromPanelBtn = document.getElementById('deleteFromPanelBtn');

    const onboard = document.getElementById('onboard');
    const onboardDone = document.getElementById('onboardDone');
    const onboardSkip = document.getElementById('onboardSkip');

    // ---------------- Helpers
    function uid(){ return `t-${Date.now()}-${Math.floor(Math.random()*9000)}`; }
    function fmtISO(v){ if(!v) return ''; try { return new Date(v).toISOString().slice(0,10); } catch { return v } }
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function computeUrgencyClass(d){
      if (!d) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const dd = new Date(d); dd.setHours(0,0,0,0);
      const diff = Math.round((dd - today) / (1000*60*60*24));
      if (diff < 0) return 'due-overdue';
      if (diff <= 2) return 'due-approach';
      return 'due-on-time';
    }

    // ---------------- Persistence: localStorage
    function saveLocal(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ tasks }));
      localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
    }
    function loadLocal(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try { const data = JSON.parse(raw); tasks = data.tasks || {}; } catch(e){ console.warn('loadLocal failed', e) }
    }

    // ---------------- Supabase auth: magic link
    magicBtn.addEventListener('click', async ()=>{
      const email = (emailInput.value || '').trim();
      if (!email) { emailInput.focus(); return; }
      try {
        magicBtn.disabled = true;
        await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
        alert('Magic link sent ‚Äî check your email. After clicking the link, this page will detect the session automatically.');
      } catch(err){
        console.error('magic error', err);
        alert('Failed to send magic link. Check console.');
      } finally { magicBtn.disabled = false; }
    });

    // Demo dataset: quick fill to test app without auth
    demoBtn.addEventListener('click', ()=>{
      tasks = {};
      const sample = [
        { title: 'Fix signup bug', quadrant:'do-first', due: fmtISO(new Date(Date.now()+86400000)), label:'client' },
        { title: 'Plan Q2 roadmap', quadrant:'schedule', due: fmtISO(new Date(Date.now()+7*86400000)), label:'' },
        { title: 'Buy groceries', quadrant:'delegate', due:'', label:'personal' },
        { title: 'Clean inbox', quadrant:'eliminate', due:'', label:'' }
      ];
      sample.forEach(s=>{
        const id=uid();
        tasks[id] = { id, title:s.title, description:'', due:s.due, quadrant:s.quadrant, label:s.label||'', completed:false, createdAt:Date.now() };
      });
      saveLocal(); render();
      // switch to app view
      showApp(true);
    });

    // ---------------- Supabase session listener
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session && session.user) {
        currentUser = session.user;
        // hide auth and show app
        showApp(true);
        await syncFromServer();
        render();
        signOutBtn.style.display = 'inline-block';
        accountBtn.style.display = 'inline-block';
      } else {
        currentUser = null;
        // keep local tasks available but show auth card
        showApp(false);
        signOutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
      }
    });

    // ---------------- Render helpers
    function createTaskNode(t){
      const div = document.createElement('div');
      div.className = 'task'; div.dataset.id = t.id;
      if (t.completed) div.classList.add('completed');
      const urg = computeUrgencyClass(t.due);
      if (urg) div.classList.add(urg);

      const left = document.createElement('div'); left.className='task-left';
      let titleHtml = `<div class="task-title">${escapeHtml(t.title)}`;
      if (t.label){
        if (t.label === 'client') titleHtml += ` <span class="tag tag-client">Client</span>`;
        if (t.label === 'personal') titleHtml += ` <span class="tag tag-personal">Personal</span>`;
        if (t.label === 'urgent') titleHtml += ` <span class="tag tag-urgent">Urgent</span>`;
      }
      titleHtml += `</div>`;
      left.innerHTML = titleHtml + (t.description ? `<div class="task-desc">${escapeHtml(t.description)}</div>` : '') + (t.due ? `<div class="task-due">${escapeHtml(t.due)}</div>` : '');

      const controls = document.createElement('div'); controls.className='task-controls';
      const completeBtn = document.createElement('button'); completeBtn.className='small-btn'; completeBtn.textContent = t.completed ? '‚Ü∫' : '‚úî';
      completeBtn.title = t.completed ? 'Mark incomplete' : 'Mark complete';
      completeBtn.onclick = (e)=> { e.stopPropagation(); toggleComplete(t.id) };
      const editBtn = document.createElement('button'); editBtn.className='small-btn'; editBtn.textContent='‚úé'; editBtn.title='Edit'; editBtn.onclick = (e)=> { e.stopPropagation(); openPanel(t.id) };
      const calBtn = document.createElement('button'); calBtn.className='small-btn'; calBtn.textContent='üìÖ'; calBtn.title='Add to calendar'; calBtn.onclick = (e)=> { e.stopPropagation(); openPanel(t.id); setTimeout(()=> addToCalendarFor(t), 250); };
      const delBtn = document.createElement('button'); delBtn.className='small-btn'; delBtn.textContent='‚úï'; delBtn.title='Delete'; delBtn.onclick = (e)=> { e.stopPropagation(); deleteTask(t.id) };

      controls.appendChild(completeBtn);
      controls.appendChild(editBtn);
      controls.appendChild(calBtn);
      controls.appendChild(delBtn);

      div.appendChild(controls);
      div.appendChild(left);

      // drag
      div.draggable = true;
      div.addEventListener('dragstart', ()=> { dragged = div; setTimeout(()=>div.style.display='none',0); });
      div.addEventListener('dragend', ()=> { if (dragged) dragged.style.display='flex'; dragged=null; });

      div.addEventListener('dblclick', ()=> openPanel(t.id));
      return div;
    }

    function render(){
      quadrants.forEach(q=>{
        const container = document.getElementById(`${q}-tasks`);
        container.innerHTML = '';
        const list = Object.values(tasks).filter(t=>t.quadrant===q);
        list.sort((a,b)=>{
          if (a.due && b.due) return new Date(a.due) - new Date(b.due);
          if (a.due) return -1;
          if (b.due) return 1;
          return a.createdAt - b.createdAt;
        });
        list.forEach(t=>{
          if (!matchesSearch(t)) return;
          const node = createTaskNode(t);
          if (!prefs.showCompleted && t.completed) node.style.display = 'none';
          container.appendChild(node);
        });
      });
      updateCounts(); updateProgress(); saveLocal();
      if (currentUser) syncToServer().catch(e=>console.warn('sync error',e));
    }

    function matchesSearch(t){
      const term = (searchInput.value || '').trim().toLowerCase();
      if (!term) return true;
      return (t.title + ' ' + (t.description||'') + ' ' + (t.due||'') + ' ' + (t.label||'')).toLowerCase().includes(term);
    }

    // ---------------- CRUD
    function addTaskFromFormQuick(){
      const title = taskTitle.value.trim();
      if (!title) { taskTitle.focus(); return; }
      const id = uid();
      tasks[id] = {
        id,
        title,
        description: taskDesc.value.trim(),
        due: taskDue.value || '',
        quadrant: taskQuadrant.value || 'do-first',
        label: taskLabel.value || '',
        completed: false,
        createdAt: Date.now()
      };
      taskTitle.value=''; taskDesc.value=''; taskDue.value=''; taskQuadrant.value='do-first'; taskLabel.value='';
      render();
    }

    function deleteTask(id){
      if (!confirm('Delete this task?')) return;
      delete tasks[id];
      render();
    }

    function toggleComplete(id){
      const t = tasks[id]; if (!t) return;
      t.completed = !t.completed;
      render();
    }

    // ---------------- Slide-out panel
    function openPanel(id){
      editingId = id;
      const t = tasks[id];
      if (!t) return;
      pTitle.value = t.title || '';
      pDesc.value = t.description || '';
      pDue.value = t.due || '';
      pQuadrant.value = t.quadrant || 'do-first';
      pLabel.value = t.label || '';
      pCompleted.checked = !!t.completed;
      document.getElementById('panelTitle').textContent = 'Edit task';
      showPanel(true);
    }
    function openPanelForNew(){
      editingId = null;
      pTitle.value=''; pDesc.value=''; pDue.value=''; pQuadrant.value='do-first'; pLabel.value=''; pCompleted.checked=false;
      document.getElementById('panelTitle').textContent = 'New task';
      showPanel(true);
    }
    function showPanel(show){
      if (show){ slidePanel.classList.add('show'); panelBackdrop.classList.add('show'); slidePanel.setAttribute('aria-hidden','false'); }
      else { slidePanel.classList.remove('show'); panelBackdrop.classList.remove('show'); slidePanel.setAttribute('aria-hidden','true'); editingId = null; }
    }
    panelCancel.addEventListener('click', ()=> showPanel(false));
    panelBackdrop.addEventListener('click', ()=> showPanel(false));

    panelSave.addEventListener('click', ()=>{
      if (!editingId){
        const id = uid();
        tasks[id] = { id, title: pTitle.value.trim() || 'Untitled', description: pDesc.value.trim(), due: pDue.value || '', quadrant: pQuadrant.value || 'do-first', label: pLabel.value || '', completed: !!pCompleted.checked, createdAt: Date.now() };
      } else {
        const t = tasks[editingId]; if (!t) return showPanel(false);
        t.title = pTitle.value.trim() || t.title;
        t.description = pDesc.value.trim();
        t.due = pDue.value || '';
        t.quadrant = pQuadrant.value;
        t.label = pLabel.value || '';
        t.completed = !!pCompleted.checked;
      }
      showPanel(false);
      render();
    });

    deleteFromPanelBtn.addEventListener('click', ()=>{
      if (!editingId) return;
      if (!confirm('Delete this task?')) return;
      delete tasks[editingId];
      showPanel(false);
      render();
    });

    // ---------------- Drag targets
    document.querySelectorAll('.quadrant').forEach(qEl=>{
      qEl.addEventListener('dragover', e=> e.preventDefault());
      qEl.addEventListener('drop', e=>{
        e.preventDefault();
        if (!dragged) return;
        const id = dragged.dataset.id;
        const target = qEl.dataset.q;
        if (tasks[id]) tasks[id].quadrant = target;
        render();
      });
    });

    // ---------------- counts & progress
    function totalIn(q){ return Object.values(tasks).filter(t=>t.quadrant===q).length }
    function doneIn(q){ return Object.values(tasks).filter(t=>t.quadrant===q && t.completed).length }
    function updateCounts(){
      quadrants.forEach(q=>{
        const total = totalIn(q), done = doneIn(q);
        const el = document.getElementById(`${q}-count`);
        if (el) el.textContent = `(${done}/${total} done)`;
      });
    }
    function updateProgress(){
      quadrants.forEach(q=>{
        const total = totalIn(q), done = doneIn(q);
        const pct = total === 0 ? 0 : Math.round((done/total)*100);
        const fill = document.getElementById(`${q}-fill`);
        if (fill) fill.style.width = pct + '%';
      });
    }

    // ---------------- search & filter
    searchInput.addEventListener('input', ()=> render());
    toggleCompletedBtn.addEventListener('click', ()=>{
      prefs.showCompleted = !prefs.showCompleted;
      toggleCompletedBtn.textContent = prefs.showCompleted ? 'Hide Completed' : 'Show Completed';
      saveLocal(); render();
    });
    toggleCompletedBtn.textContent = prefs.showCompleted ? 'Hide Completed' : 'Show Completed';

    // ---------------- export / import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify({ tasks }, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'priobox-tasks.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> importFileInput.click());
    importFileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try {
          const obj = JSON.parse(r.result);
          if (obj.tasks){
            Object.values(obj.tasks).forEach(t=>{
              let id = t.id;
              if (!id || tasks[id]) id = uid();
              tasks[id] = {...t, id};
            });
            render(); alert('Imported tasks');
          } else alert('No tasks found');
        } catch(e){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
      importFileInput.value = '';
    });

    // ---------------- calendar integration
    function downloadICSFor(t){
      if (!t || !t.due) { alert('Task must have a due date to export'); return; }
      const start = new Date(t.due + 'T09:00:00');
      const end = new Date(start.getTime() + 60*60*1000);
      function fmt(dt){ return dt.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z'; }
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//PrioBox//EN','BEGIN:VEVENT',
        `UID:${t.id}`, `DTSTAMP:${fmt(new Date())}`, `DTSTART:${fmt(start)}`, `DTEND:${fmt(end)}`,
        `SUMMARY:${t.title}`, `DESCRIPTION:${(t.description||'').replace(/\n/g,'\\n')}`, 'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${t.title.slice(0,40)}.ics`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function openGoogleCalendarFor(t){
      if (!t || !t.due) { alert('Task must have a due date to add to Google Calendar'); return; }
      const start = new Date(t.due + 'T09:00:00'); const end = new Date(start.getTime() + 60*60*1000);
      function fmtLocal(dt){ return dt.toISOString().slice(0,19).replace(/-|:/g,'') + 'Z' }
      const dates = `${fmtLocal(start)}/${fmtLocal(end)}`;
      const text = encodeURIComponent(t.title);
      const details = encodeURIComponent(t.description || '');
      const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&details=${details}`;
      window.open(url, '_blank');
    }
    function addToCalendarFor(t){ openGoogleCalendarFor(t); }

    addToCalendarBtn.addEventListener('click', ()=>{
      if (!editingId) return alert('Open a task to add to calendar');
      const t = tasks[editingId]; openGoogleCalendarFor(t);
    });
    downloadICSBtn.addEventListener('click', ()=>{
      if (!editingId) return alert('Open a task to download .ics');
      const t = tasks[editingId]; downloadICSFor(t);
    });

    // ---------------- Supabase sync methods
    async function syncFromServer(){
      try {
        if (!currentUser) return;
        const { data, error } = await supabase.from('tasks').select('id, payload').eq('user_id', currentUser.id);
        if (error){ console.warn('syncFromServer', error); return; }
        const serverTasks = {};
        (data || []).forEach(r => { serverTasks[r.id] = r.payload; });
        tasks = serverTasks;
        saveLocal(); render();
      } catch(err){ console.warn('syncFromServer err', err); }
    }

    async function syncToServer(){
      try {
        if (!currentUser) return;
        const rows = Object.values(tasks).map(t => ({ id: t.id, user_id: currentUser.id, payload: t }));
        if (rows.length === 0) return;
        const { error } = await supabase.from('tasks').upsert(rows, { onConflict: ['id'] });
        if (error) console.warn('syncToServer error', error);
      } catch(err){ console.warn('syncToServer', err); }
    }

    // ---------------- Auth UI & sign-out
    signOutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      showApp(false);
      alert('Signed out');
    });

    accountBtn.addEventListener('click', async ()=>{
      const s = await supabase.auth.getUser();
      if (s && s.data && s.data.user) {
        alert('Signed in as ' + (s.data.user.email || s.data.user.id));
      } else alert('No account info');
    });

    // ---------------- UI toggles & keyboard
    document.getElementById('addBtn').addEventListener('click', ()=> {
      if (taskTitle.value.trim()) { addTaskFromFormQuick(); return; }
      openPanelForNew();
    });
    clearBtn.addEventListener('click', ()=> {
      if (!confirm('Clear all tasks?')) return;
      tasks = {}; saveLocal(); render();
    });

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') { showPanel(false); hideOnboarding(); }
      if (e.key.toLowerCase() === 'n') { taskTitle.focus(); }
      if (e.key === 'Enter' && (document.activeElement === taskTitle || document.activeElement === taskDesc || document.activeElement === taskDue)) addTaskFromFormQuick();
    });

    // ---------------- onboarding
    function showOnboarding(){ onboard.classList.add('show'); onboard.setAttribute('aria-hidden','false'); }
    function hideOnboarding(){ onboard.classList.remove('show'); onboard.setAttribute('aria-hidden','true'); localStorage.setItem('prio_onboard_v4','seen'); }
    onboardDone.addEventListener('click', ()=> hideOnboarding());
    onboardSkip.addEventListener('click', ()=> hideOnboarding());

    // ---------------- load & boot
    function showApp(visible){
      if (visible){
        authCard.style.display = 'none'; appArea.style.display = 'block';
      } else {
        authCard.style.display = 'block'; appArea.style.display = 'none';
      }
    }

    function loadAll(){
      loadLocal();
      const raw = localStorage.getItem(PREFS_KEY);
      if (raw) try { prefs = JSON.parse(raw); } catch(e){}
      toggleCompletedBtn.textContent = prefs.showCompleted ? 'Hide Completed' : 'Show Completed';
      if (!localStorage.getItem('prio_onboard_v4')) setTimeout(()=> showOnboarding(), 700);

      // restore Supabase session if present
      supabase.auth.getSession().then(res=>{
        if (res && res.data && res.data.session && res.data.session.user){
          currentUser = res.data.session.user;
          signOutBtn.style.display = 'inline-block'; accountBtn.style.display = 'inline-block';
          showApp(true);
          syncFromServer();
        } else {
          // not signed in
          showApp(true); // show app so user can use local data even before signing in
        }
        render();
      });
    }

    // ---------------- local prefs wrapper
    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ tasks })); localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }

    // ---------------- boot
    loadAll();
    render();

    // expose debug
    window.priobox = { tasks, render, supabase, syncToServer, syncFromServer };

  </script>
</body>
</html>
