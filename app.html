<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrioBox ‚Äî Focus What Matters</title>
  <style>
    :root {
      --bg: #fafbfc;
      --panel: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #eff6ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --sidebar-width: 240px;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow: hidden; }
    .app-container { display: flex; height: 100vh; }
    
    /* Sidebar */
    .sidebar { width: var(--sidebar-width); background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
    .logo { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .logo h1 { margin: 0; font-size: 20px; font-weight: 700; }
    .nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; font-size: 14px; font-weight: 500; color: var(--text-muted); }
    .nav-item:hover { background: var(--bg); color: var(--text); }
    .nav-item.active { background: var(--accent-light); color: var(--accent); border-left-color: var(--accent); }
    .nav-icon { font-size: 18px; width: 24px; text-align: center; }
    .nav-badge { margin-left: auto; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    
    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { background: var(--panel); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow-sm); }
    .search-bar { flex: 1; max-width: 500px; position: relative; }
    .search-bar input { width: 100%; padding: 10px 40px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
    .search-bar input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .search-kbd { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--text-muted); background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }
    .btn { padding: 10px 18px; border: 1px solid var(--border); background: var(--panel); color: var(--text); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { background: var(--bg); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-icon { padding: 10px; }
    .content-area { flex: 1; overflow-y: auto; padding: 24px; }
    
    /* Stats */
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-mini { background: var(--panel); padding: 16px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
    .stat-mini:hover { box-shadow: var(--shadow-md); }
    .stat-mini-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-mini-value { font-size: 24px; font-weight: 700; }
    .stat-mini-icon { font-size: 32px; opacity: 0.3; }
    
    /* Section */
    .section { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
    .section-header { padding: 16px 20px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .section-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .section-actions { display: flex; gap: 8px; }
    .section-content { padding: 16px; }
    
    /* Tasks */
    .task-list { display: flex; flex-direction: column; gap: 8px; }
    .task { background: var(--panel); padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: flex-start; gap: 12px; transition: all 0.2s; cursor: pointer; }
    .task:hover { box-shadow: var(--shadow-md); border-color: var(--accent); transform: translateX(2px); }
    .task.completed { opacity: 0.6; }
    .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .task-checkbox:hover { border-color: var(--success); background: #d1fae5; }
    .task-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
    .task-main { flex: 1; min-width: 0; }
    .task-title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .aging-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .aging-dot.fresh { background: var(--success); }
    .aging-dot.aging { background: var(--warning); }
    .aging-dot.stale { background: var(--danger); animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .task-title { font-weight: 600; font-size: 14px; flex: 1; }
    .task.completed .task-title { text-decoration: line-through; }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); align-items: center; }
    .task-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: var(--bg); }
    .task-badge.project { background: #e0e7ff; color: #4338ca; }
    .task-badge.tag { background: #fef3c7; color: #92400e; }
    .task-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
    .task:hover .task-actions { opacity: 1; }
    .task-action-btn { padding: 6px 8px; background: transparent; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; transition: all 0.2s; color: var(--text-muted); }
    .task-action-btn:hover { background: var(--bg); color: var(--text); }
    .progress-bar { width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: var(--success); transition: width 0.3s ease; }
    
    /* Matrix */
    .matrix-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .quadrant { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .quadrant-header { padding: 14px 16px; font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .quadrant.do-first { border-top: 3px solid var(--danger); }
    .quadrant.schedule { border-top: 3px solid var(--warning); }
    .quadrant.delegate { border-top: 3px solid var(--success); }
    .quadrant.eliminate { border-top: 3px solid var(--accent); }
    .quadrant-content { padding: 12px; min-height: 200px; }
    .quadrant-count { background: var(--bg); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    
    /* Timer */
    .timer-float { position: fixed; bottom: 24px; right: 24px; background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-lg); color: white; min-width: 280px; z-index: 100; transition: all 0.3s; }
    .timer-float.minimized { min-width: auto; padding: 16px; cursor: pointer; }
    .timer-float.minimized .timer-content { display: none; }
    .timer-display { font-size: 36px; font-weight: 700; text-align: center; margin: 12px 0; font-variant-numeric: tabular-nums; }
    .timer-controls { display: flex; gap: 8px; justify-content: center; }
    .timer-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .timer-btn:hover { background: rgba(255,255,255,0.3); }
    .timer-info { text-align: center; margin-top: 12px; font-size: 13px; opacity: 0.9; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--panel); border-radius: 16px; box-shadow: var(--shadow-lg); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; animation: modalIn 0.2s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 20px; font-weight: 700; margin: 0; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
    .form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
    .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    textarea.form-input { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; gap: 10px; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 64px; opacity: 0.3; margin-bottom: 16px; }
    .hidden { display: none !important; }
    
    /* Command Palette */
    .command-palette { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: var(--panel); border-radius: 12px; box-shadow: var(--shadow-lg); width: 90%; max-width: 600px; z-index: 2000; display: none; }
    .command-palette.open { display: block; animation: modalIn 0.2s ease; }
    .command-input { width: 100%; padding: 20px; border: none; font-size: 16px; border-bottom: 1px solid var(--border); }
    .command-input:focus { outline: none; }
    .command-results { max-height: 400px; overflow-y: auto; padding: 8px; }
    .command-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
    .command-item:hover { background: var(--accent-light); }
    
    .subtask-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; margin-bottom: 6px; background: var(--bg); }
    .tags-container { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .tag-chip { background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .tag-chip button { background: none; border: none; padding: 0; cursor: pointer; color: inherit; font-size: 14px; line-height: 1; }
    
    .project-card { background: var(--bg); padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid var(--border); }
    .project-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .project-name { font-weight: 700; font-size: 16px; }
    .history-item { padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--success); }
    
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -240px; top: 0; bottom: 0; z-index: 999; transition: left 0.3s; }
      .sidebar.open { left: 0; }
      .matrix-grid { grid-template-columns: 1fr; }
      .timer-float { bottom: 16px; right: 16px; min-width: 220px; }
      .search-kbd { display: none; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <svg width="32" height="32" viewBox="0 0 100 100">
          <rect x="8" y="8" width="38" height="38" rx="6" fill="#ef4444"/>
          <rect x="54" y="8" width="38" height="38" rx="6" fill="#f59e0b"/>
          <rect x="8" y="54" width="38" height="38" rx="6" fill="#10b981"/>
          <rect x="54" y="54" width="38" height="38" rx="6" fill="#3b82f6"/>
        </svg>
        <h1>PrioBox</h1>
      </div>
      <nav class="nav">
        <div class="nav-item active" data-view="dashboard"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg></span><span>Dashboard</span></div>
        <div class="nav-item" data-view="focus"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
          </svg></span><span>Focus Mode</span><span class="nav-badge" id="focusCount">0</span></div>
        <div class="nav-item" data-view="matrix"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/>
          </svg></span><span>Matrix View</span></div>
        <div class="nav-item" data-view="projects"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg></span><span>Projects</span></div>
        <div class="nav-item" data-view="history"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg></span><span>Completed</span></div>
        <div class="nav-item" data-view="insights"><span class="nav-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
          </svg></span><span>Insights</span></div>
      </nav>
      <div class="sidebar-footer">
        <button class="btn btn-primary" style="width: 100%;" id="newTaskBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span>New Task</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div class="search-bar">
          <span class="search-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
          </span>
          <input type="text" placeholder="Search tasks or quick add..." id="searchInput">
          <span class="search-kbd">‚åòK</span>
        </div>
        <button class="btn" id="autoPrioritizeBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
          <span>Auto-Prioritize</span>
        </button>
        <button class="btn btn-icon" id="filterBtn" title="Filter">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
        </button>
      </div>

      <div class="content-area" id="contentArea">
        <!-- Dashboard View -->
        <div id="dashboardView">
          <div class="stats-bar">
            <div class="stat-mini">
              <div><div class="stat-mini-label">Today's Focus</div><div class="stat-mini-value" id="todayCount">0</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Consistency</div><div class="stat-mini-value" id="streakValue">0/7</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Completed Today</div><div class="stat-mini-value" id="completedToday">0</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Stale Tasks</div><div class="stat-mini-value" id="staleCount">0</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <span>Smart Priority Queue</span>
              </div>
              <div class="section-actions">
                <button class="btn btn-icon" id="refreshPriority">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="section-content"><div class="task-list" id="priorityQueue"></div></div>
          </div>

          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>Matrix Overview</span>
              </div>
            </div>
            <div class="section-content">
              <div class="matrix-grid">
                <div class="quadrant do-first">
                  <div class="quadrant-header">
                    <span>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                        <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                      </svg>
                      Do First
                    </span>
                    <span class="quadrant-count" id="countDoFirst">0</span>
                  </div>
                  <div class="quadrant-content"><div class="task-list" id="quickDoFirst"></div></div>
                </div>
                <div class="quadrant schedule">
                  <div class="quadrant-header">
                    <span>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      Schedule
                    </span>
                    <span class="quadrant-count" id="countSchedule">0</span>
                  </div>
                  <div class="quadrant-content"><div class="task-list" id="quickSchedule"></div></div>
                </div>
                <div class="quadrant delegate">
                  <div class="quadrant-header">
                    <span>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                      </svg>
                      Delegate
                    </span>
                    <span class="quadrant-count" id="countDelegate">0</span>
                  </div>
                  <div class="quadrant-content"><div class="task-list" id="quickDelegate"></div></div>
                </div>
                <div class="quadrant eliminate">
                  <div class="quadrant-header">
                    <span>
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                      Eliminate
                    </span>
                    <span class="quadrant-count" id="countEliminate">0</span>
                  </div>
                  <div class="quadrant-content"><div class="task-list" id="quickEliminate"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Focus Mode -->
        <div id="focusView" class="hidden">
          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Today's Focus</span>
              </div>
            </div>
            <div class="section-content"><div class="task-list" id="focusList"></div></div>
          </div>
        </div>

        <!-- Matrix View -->
        <div id="matrixView" class="hidden">
          <div class="matrix-grid">
            <div class="quadrant do-first">
              <div class="quadrant-header">
                <span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                    <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                  </svg>
                  Do First
                </span>
                <span class="quadrant-count" id="fullCountDoFirst">0</span>
              </div>
              <div class="quadrant-content"><div class="task-list" id="fullDoFirst"></div></div>
            </div>
            <div class="quadrant schedule">
              <div class="quadrant-header">
                <span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  Schedule
                </span>
                <span class="quadrant-count" id="fullCountSchedule">0</span>
              </div>
              <div class="quadrant-content"><div class="task-list" id="fullSchedule"></div></div>
            </div>
            <div class="quadrant delegate">
              <div class="quadrant-header">
                <span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  Delegate
                </span>
                <span class="quadrant-count" id="fullCountDelegate">0</span>
              </div>
              <div class="quadrant-content"><div class="task-list" id="fullDelegate"></div></div>
            </div>
            <div class="quadrant eliminate">
              <div class="quadrant-header">
                <span>
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 6px;">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                  Eliminate
                </span>
                <span class="quadrant-count" id="fullCountEliminate">0</span>
              </div>
              <div class="quadrant-content"><div class="task-list" id="fullEliminate"></div></div>
            </div>
          </div>
        </div>

        <!-- Projects View -->
        <div id="projectsView" class="hidden">
          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                <span>Projects</span>
              </div>
            </div>
            <div class="section-content" id="projectsList"></div>
          </div>
        </div>

        <!-- History View -->
        <div id="historyView" class="hidden">
          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <span>Completed Tasks</span>
              </div>
            </div>
            <div class="section-content" id="historyList"></div>
          </div>
        </div>

        <!-- Insights View -->
        <div id="insightsView" class="hidden">
          <div class="stats-bar">
            <div class="stat-mini">
              <div><div class="stat-mini-label">Total Tasks</div><div class="stat-mini-value" id="insightTotalTasks">0</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Completion Rate</div><div class="stat-mini-value" id="insightCompletionRate">0%</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Avg. Time to Complete</div><div class="stat-mini-value" id="insightAvgTime">0d</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Most Productive Day</div><div class="stat-mini-value" id="insightBestDay">‚Äî</div></div>
              <div class="stat-mini-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>7-Day Activity</span>
              </div>
            </div>
            <div class="section-content">
              <div id="activityChart" style="display: flex; align-items: flex-end; justify-content: space-around; gap: 12px; height: 200px; padding: 20px;"></div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
            <div class="section">
              <div class="section-header">
                <div class="section-title">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                  </svg>
                  <span>Tasks by Quadrant</span>
                </div>
              </div>
              <div class="section-content" id="quadrantBreakdown"></div>
            </div>

            <div class="section">
              <div class="section-header">
                <div class="section-title">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                  </svg>
                  <span>Top Projects</span>
                </div>
              </div>
              <div class="section-content" id="topProjects"></div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <div class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span>Aging Tasks Alert</span>
              </div>
            </div>
            <div class="section-content" id="agingTasks"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Timer -->
  <div class="timer-float" id="timerFloat">
    <div class="timer-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span style="font-weight: 600;">Focus Timer</span>
        <button class="timer-btn" style="padding: 4px 8px; font-size: 11px;" id="timerMinimize">‚àí</button>
      </div>
      <div class="timer-display" id="timerDisplay">25:00</div>
      <div class="timer-controls">
        <button class="timer-btn" id="timerStart">‚ñ∂ Start</button>
        <button class="timer-btn hidden" id="timerPause">‚è∏ Pause</button>
        <button class="timer-btn" id="timerReset">‚Üª Reset</button>
      </div>
      <div class="timer-info">Sessions today: <strong id="sessionsToday">0</strong></div>
    </div>
    <div id="timerMinimizedContent" class="hidden">‚è± <span id="timerMinDisplay">25:00</span></div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">New Task</h3>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="taskId">
        <div class="form-group">
          <label class="form-label">Task Title *</label>
          <input class="form-input" id="taskTitle" placeholder="What needs to be done?">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="taskDescription" placeholder="Add details..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Estimated Minutes</label>
            <input class="form-input" id="taskEstimate" type="number" min="1" placeholder="30">
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input class="form-input" id="taskDue" type="date">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Quadrant</label>
          <select class="form-input" id="taskQuadrant">
            <option value="do-first">üî• Do First (Urgent & Important)</option>
            <option value="schedule">üìÖ Schedule (Important, Not Urgent)</option>
            <option value="delegate">üë• Delegate (Urgent, Not Important)</option>
            <option value="eliminate">üóëÔ∏è Eliminate (Neither)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Project</label>
          <input class="form-input" id="taskProject" placeholder="e.g., Website Redesign">
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div class="tags-container" id="taskTags"></div>
          <div style="display: flex; gap: 6px; margin-top: 8px;">
            <input class="form-input" id="newTag" placeholder="Add tag..." style="flex: 1;">
            <button class="btn" id="addTagBtn">+ Add</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Subtasks</label>
          <div id="subtasksList"></div>
          <div style="display: flex; gap: 6px; margin-top: 8px;">
            <input class="form-input" id="newSubtask" placeholder="Add subtask..." style="flex: 1;">
            <button class="btn" id="addSubtaskBtn">+ Add</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="deleteTaskBtn" style="background: var(--danger); color: white; border-color: var(--danger);">Delete</button>
        <div style="display: flex; gap: 10px;">
          <button class="btn" id="cancelTaskBtn">Cancel</button>
          <button class="btn btn-primary" id="saveTaskBtn">Save Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="command-palette" id="commandPalette">
    <input class="command-input" id="commandInput" placeholder="Type to search or create...">
    <div class="command-results" id="commandResults"></div>
  </div>

  <script>
    'use strict';

    // Store
    class TaskStore {
      constructor() {
        this.STORAGE_KEY = 'priobox_v4';
        this.PREFS_KEY = 'priobox_prefs_v4';
        this.tasks = {};
        this.prefs = { timerSessionsHistory: {}, completedHistory: {} };
        this.load();
      }
      load() {
        try {
          const t = localStorage.getItem(this.STORAGE_KEY);
          const p = localStorage.getItem(this.PREFS_KEY);
          if (t) this.tasks = JSON.parse(t);
          if (p) this.prefs = {...this.prefs, ...JSON.parse(p)};
        } catch(e) { console.error(e); }
      }
      save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.tasks)); }
      savePrefs() { localStorage.setItem(this.PREFS_KEY, JSON.stringify(this.prefs)); }
      addTask(data) {
        const id = 't-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        this.tasks[id] = {
          id, title: data.title || 'Untitled', description: data.description || '',
          due: data.due || '', quadrant: data.quadrant || 'do-first', completed: false,
          createdAt: Date.now(), estimatedMinutes: data.estimatedMinutes || 0,
          totalMinutes: 0, lastTouched: Date.now(), subtasks: data.subtasks || [],
          tags: data.tags || [], project: data.project || '', completedAt: null
        };
        this.save();
        return id;
      }
      updateTask(id, updates) {
        if (!this.tasks[id]) return false;
        this.tasks[id] = {...this.tasks[id], ...updates, lastTouched: Date.now()};
        this.save();
        return true;
      }
      deleteTask(id) { delete this.tasks[id]; this.save(); }
      toggleComplete(id) {
        const t = this.tasks[id];
        if (!t) return;
        t.completed = !t.completed;
        t.completedAt = t.completed ? Date.now() : null;
        t.lastTouched = Date.now();
        
        // Auto-complete parent if all subtasks done
        if (t.subtasks && t.subtasks.length > 0 && t.subtasks.every(st => st.completed)) {
          t.completed = true;
          t.completedAt = Date.now();
        }
        
        if (t.completed) {
          const d = new Date().toDateString();
          this.prefs.completedHistory[d] = (this.prefs.completedHistory[d]||0) + 1;
          this.savePrefs();
        }
        this.save();
      }
      toggleSubtask(taskId, subtaskId) {
        const t = this.tasks[taskId];
        if (!t || !t.subtasks) return false;
        const st = t.subtasks.find(s => s.id === subtaskId);
        if (!st) return false;
        st.completed = !st.completed;
        
        // Auto-complete parent if all subtasks done
        if (t.subtasks.every(s => s.completed) && !t.completed) {
          t.completed = true;
          t.completedAt = Date.now();
          const d = new Date().toDateString();
          this.prefs.completedHistory[d] = (this.prefs.completedHistory[d]||0) + 1;
          this.savePrefs();
        } else if (t.completed && t.subtasks.some(s => !s.completed)) {
          t.completed = false;
          t.completedAt = null;
        }
        
        t.lastTouched = Date.now();
        this.save();
        return true;
      }
      getAll() {
        return Object.values(this.tasks).sort((a,b) => {
          if (a.completed !== b.completed) return a.completed ? 1 : -1;
          return b.createdAt - a.createdAt;
        });
      }
      calculatePriorityScore(task) {
        let score = 0;
        const now = Date.now();
        if (task.due) {
          const days = (new Date(task.due) - now) / (1000*60*60*24);
          if (days < 0) score += 40;
          else if (days < 1) score += 35;
          else if (days < 3) score += 25;
          else if (days < 7) score += 15;
        }
        if (task.estimatedMinutes > 0) {
          if (task.estimatedMinutes <= 15) score += 20;
          else if (task.estimatedMinutes <= 30) score += 15;
          else if (task.estimatedMinutes <= 60) score += 10;
          else score += 5;
        }
        const daysSince = (now - task.lastTouched) / (1000*60*60*24);
        if (daysSince < 1) score += 20;
        else if (daysSince < 3) score += 15;
        else if (daysSince < 7) score += 10;
        else if (daysSince >= 14) score -= 10;
        if (task.quadrant === 'do-first') score += 20;
        else if (task.quadrant === 'schedule') score += 10;
        else if (task.quadrant === 'delegate') score += 5;
        return score;
      }
      getProjects() {
        const projects = {};
        Object.values(this.tasks).forEach(t => {
          if (t.project) {
            if (!projects[t.project]) {
              projects[t.project] = { name: t.project, tasks: [], completed: 0, total: 0 };
            }
            projects[t.project].tasks.push(t);
            projects[t.project].total++;
            if (t.completed) projects[t.project].completed++;
          }
        });
        return Object.values(projects);
      }
    }

    const store = new TaskStore();
    let currentView = 'dashboard';
    let currentEditingTask = null;

    // Timer
    class Timer {
      constructor() {
        this.time = 25*60;
        this.running = false;
        this.interval = null;
      }
      start() {
        if (this.running) return;
        this.running = true;
        document.getElementById('timerStart').classList.add('hidden');
        document.getElementById('timerPause').classList.remove('hidden');
        this.interval = setInterval(() => {
          this.time--;
          this.updateDisplay();
          if (this.time <= 0) this.complete();
        }, 1000);
      }
      pause() {
        this.running = false;
        clearInterval(this.interval);
        document.getElementById('timerStart').classList.remove('hidden');
        document.getElementById('timerPause').classList.add('hidden');
      }
      reset() {
        this.pause();
        this.time = 25*60;
        this.updateDisplay();
      }
      complete() {
        this.pause();
        const d = new Date().toDateString();
        store.prefs.timerSessionsHistory[d] = (store.prefs.timerSessionsHistory[d]||0) + 1;
        store.savePrefs();
        alert('üéâ Focus session complete!');
        this.reset();
        render();
      }
      updateDisplay() {
        const m = String(Math.floor(this.time/60)).padStart(2,'0');
        const s = String(this.time%60).padStart(2,'0');
        const display = `${m}:${s}`;
        document.getElementById('timerDisplay').textContent = display;
        document.getElementById('timerMinDisplay').textContent = display;
      }
    }

    const timer = new Timer();

    // Utils
    function daysSince(ts) {
      return Math.floor((Date.now() - ts) / (1000*60*60*24));
    }
    function getAgingStatus(ts) {
      const d = daysSince(ts);
      if (d < 3) return 'fresh';
      if (d < 7) return 'aging';
      return 'stale';
    }
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const today = new Date();
      today.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      const diff = (d - today) / (1000*60*60*24);
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 0) return `${Math.abs(diff)}d overdue`;
      return `In ${diff}d`;
    }
    function formatRelativeTime(ts) {
      const mins = Math.floor((Date.now() - ts) / (1000*60));
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return new Date(ts).toLocaleDateString();
    }

    // Task Element
    function createTaskElement(task) {
      const el = document.createElement('div');
      el.className = 'task' + (task.completed ? ' completed' : '');
      
      const checkbox = document.createElement('div');
      checkbox.className = 'task-checkbox' + (task.completed ? ' checked' : '');
      if (task.completed) checkbox.textContent = '‚úì';
      checkbox.onclick = (e) => { 
        e.stopPropagation(); 
        store.toggleComplete(task.id); 
        render(); 
      };
      el.appendChild(checkbox);
      
      const main = document.createElement('div');
      main.className = 'task-main';
      
      const titleRow = document.createElement('div');
      titleRow.className = 'task-title-row';
      
      const dot = document.createElement('span');
      dot.className = 'aging-dot ' + getAgingStatus(task.lastTouched);
      dot.title = `Last touched: ${formatRelativeTime(task.lastTouched)}`;
      titleRow.appendChild(dot);
      
      const title = document.createElement('span');
      title.className = 'task-title';
      title.textContent = task.title;
      titleRow.appendChild(title);
      
      main.appendChild(titleRow);
      
      const meta = document.createElement('div');
      meta.className = 'task-meta';
      
      if (task.project) {
        const badge = document.createElement('span');
        badge.className = 'task-badge project';
        badge.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 4px;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>' + task.project;
        meta.appendChild(badge);
      }
      
      if (task.tags && task.tags.length > 0) {
        task.tags.forEach(tag => {
          const badge = document.createElement('span');
          badge.className = 'task-badge tag';
          badge.textContent = '#' + tag;
          meta.appendChild(badge);
        });
      }
      
      if (task.subtasks && task.subtasks.length > 0) {
        const completed = task.subtasks.filter(st => st.completed).length;
        const span = document.createElement('span');
        span.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 4px;"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>' + `${completed}/${task.subtasks.length}`;
        meta.appendChild(span);
      }
      
      if (task.estimatedMinutes) {
        const span = document.createElement('span');
        span.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' + task.estimatedMinutes + 'm';
        meta.appendChild(span);
      }
      
      if (task.due) {
        const span = document.createElement('span');
        span.innerHTML = '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' + formatDate(task.due);
        const isOverdue = new Date(task.due) < new Date() && !task.completed;
        if (isOverdue) {
          span.style.color = 'var(--danger)';
          span.style.fontWeight = '600';
        }
        meta.appendChild(span);
      }
      
      main.appendChild(meta);
      
      if (task.subtasks && task.subtasks.length > 0) {
        const prog = document.createElement('div');
        prog.className = 'progress-bar';
        const fill = document.createElement('div');
        fill.className = 'progress-fill';
        const completed = task.subtasks.filter(st => st.completed).length;
        fill.style.width = (completed / task.subtasks.length * 100) + '%';
        prog.appendChild(fill);
        main.appendChild(prog);
      }
      
      el.appendChild(main);
      
      const actions = document.createElement('div');
      actions.className = 'task-actions';
      
      const editBtn = document.createElement('button');
      editBtn.className = 'task-action-btn';
      editBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
      editBtn.title = 'Edit';
      editBtn.onclick = (e) => { 
        e.stopPropagation(); 
        openTaskModal(task); 
      };
      actions.appendChild(editBtn);
      
      el.appendChild(actions);
      el.onclick = () => openTaskModal(task);
      
      return el;
    }

    // Render
    function render() {
      const tasks = store.getAll();
      const incomplete = tasks.filter(t => !t.completed);
      
      // Stats
      const today = new Date().toDateString();
      const completedToday = store.prefs.completedHistory[today] || 0;
      document.getElementById('completedToday').textContent = completedToday;
      
      const stale = incomplete.filter(t => daysSince(t.lastTouched) >= 14).length;
      document.getElementById('staleCount').textContent = stale;
      
      let consistent = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const ds = d.toDateString();
        const c = store.prefs.completedHistory[ds] || 0;
        const s = store.prefs.timerSessionsHistory[ds] || 0;
        if (c >= 3 || s >= 1) consistent++;
      }
      document.getElementById('streakValue').textContent = `${consistent}/7`;
      
      const sessions = store.prefs.timerSessionsHistory[today] || 0;
      document.getElementById('sessionsToday').textContent = sessions;
      
      // Priority Queue
      const scored = incomplete.map(t => ({ task: t, score: store.calculatePriorityScore(t) }))
        .sort((a,b) => b.score - a.score).slice(0, 5);
      const pq = document.getElementById('priorityQueue');
      pq.innerHTML = '';
      if (pq.childElementCount === 0) {
        pq.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div><div>All caught up!</div></div>';
      } else {
        scored.forEach(({task}) => pq.appendChild(createTaskElement(task)));
      }
      
      document.getElementById('todayCount').textContent = scored.length;
      document.getElementById('focusCount').textContent = scored.length;
      
      // Matrix
      ['do-first', 'schedule', 'delegate', 'eliminate'].forEach(q => {
        const qTasks = incomplete.filter(t => t.quadrant === q);
        const qName = q.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join('');
        
        // Dashboard quick view counts
        const countEl = document.getElementById('count' + qName);
        if (countEl) countEl.textContent = qTasks.length;
        
        // Matrix full view counts
        const fullCountEl = document.getElementById('fullCount' + qName);
        if (fullCountEl) fullCountEl.textContent = qTasks.length;
        
        // Dashboard quick lists (top 3)
        const quickList = document.getElementById('quick' + qName);
        if (quickList) {
          quickList.innerHTML = '';
          const tasksToShow = qTasks.slice(0, 3);
          if (tasksToShow.length === 0) {
            quickList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No tasks</div>';
          } else {
            tasksToShow.forEach(t => quickList.appendChild(createTaskElement(t)));
          }
        }
        
        // Matrix full view lists (all tasks)
        const fullList = document.getElementById('full' + qName);
        if (fullList) {
          fullList.innerHTML = '';
          if (qTasks.length === 0) {
            fullList.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="opacity: 0.5;">No tasks</div></div>';
          } else {
            qTasks.forEach(t => fullList.appendChild(createTaskElement(t)));
          }
        }
      });
      
      // Focus view
      const focusList = document.getElementById('focusList');
      focusList.innerHTML = '';
      if (scored.length === 0) {
        focusList.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div><div>No focus tasks. Great job!</div></div>';
      } else {
        scored.forEach(({task}) => focusList.appendChild(createTaskElement(task)));
      }
      
      // Projects
      const projects = store.getProjects();
      const projList = document.getElementById('projectsList');
      projList.innerHTML = '';
      if (projects.length === 0) {
        projList.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div><div>No projects yet</div></div>';
      } else {
        projects.forEach(p => {
          const card = document.createElement('div');
          card.className = 'project-card';
          card.innerHTML = `
            <div class="project-header">
              <div class="project-name">${p.name}</div>
              <div>${p.completed}/${p.total}</div>
            </div>
            <div class="progress-bar" style="margin-bottom: 12px;">
              <div class="progress-fill" style="width: ${p.total ? p.completed/p.total*100 : 0}%"></div>
            </div>
          `;
          projList.appendChild(card);
        });
      }
      
      // History
      const completed = tasks.filter(t => t.completed && t.completedAt).sort((a,b) => b.completedAt - a.completedAt);
      const histList = document.getElementById('historyList');
      histList.innerHTML = '';
      if (completed.length === 0) {
        histList.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div><div>No completed tasks yet</div></div>';
      } else {
        completed.forEach(t => {
          const item = document.createElement('div');
          item.className = 'history-item';
          item.innerHTML = `
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${formatRelativeTime(t.completedAt)}</div>
            <div style="font-weight: 600;">${t.title}</div>
          `;
          histList.appendChild(item);
        });
      }
      
      // Insights View
      if (currentView === 'insights') {
        renderInsights();
      }
    }
    
    function renderInsights() {
      const tasks = store.getAll();
      const completed = tasks.filter(t => t.completed);
      
      // Total tasks
      document.getElementById('insightTotalTasks').textContent = tasks.length;
      
      // Completion rate
      const completionRate = tasks.length > 0 ? Math.round((completed.length / tasks.length) * 100) : 0;
      document.getElementById('insightCompletionRate').textContent = completionRate + '%';
      
      // Avg time to complete
      if (completed.length > 0) {
        const avgDays = completed.reduce((sum, t) => {
          const days = (t.completedAt - t.createdAt) / (1000*60*60*24);
          return sum + days;
        }, 0) / completed.length;
        document.getElementById('insightAvgTime').textContent = Math.round(avgDays) + 'd';
      } else {
        document.getElementById('insightAvgTime').textContent = '0d';
      }
      
      // Most productive day
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const dayCounts = {};
      Object.entries(store.prefs.completedHistory).forEach(([dateStr, count]) => {
        const day = new Date(dateStr).getDay();
        dayCounts[day] = (dayCounts[day] || 0) + count;
      });
      const maxDay = Object.entries(dayCounts).sort((a,b) => b[1] - a[1])[0];
      document.getElementById('insightBestDay').textContent = maxDay ? dayNames[maxDay[0]] : '‚Äî';
      
      // 7-day activity chart
      const chartDiv = document.getElementById('activityChart');
      chartDiv.innerHTML = '';
      const maxCount = 10;
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        const count = store.prefs.completedHistory[dateStr] || 0;
        const height = Math.max(20, (count / maxCount) * 160);
        
        const bar = document.createElement('div');
        bar.style.cssText = `
          flex: 1;
          background: var(--accent);
          border-radius: 4px 4px 0 0;
          height: ${height}px;
          position: relative;
          transition: all 0.2s;
          cursor: pointer;
        `;
        bar.onmouseenter = () => { bar.style.background = 'var(--accent-hover)'; };
        bar.onmouseleave = () => { bar.style.background = 'var(--accent)'; };
        bar.title = `${dayNames[date.getDay()]}: ${count} tasks`;
        
        const label = document.createElement('div');
        label.style.cssText = 'position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; color: var(--text-muted);';
        label.textContent = dayNames[date.getDay()];
        bar.appendChild(label);
        
        chartDiv.appendChild(bar);
      }
      
      // Quadrant breakdown
      const quadBreakdown = document.getElementById('quadrantBreakdown');
      quadBreakdown.innerHTML = '';
      const quadCounts = { 'do-first': 0, 'schedule': 0, 'delegate': 0, 'eliminate': 0 };
      tasks.forEach(t => quadCounts[t.quadrant]++);
      const quadNames = { 'do-first': 'Do First', 'schedule': 'Schedule', 'delegate': 'Delegate', 'eliminate': 'Eliminate' };
      const quadColors = { 'do-first': '#ef4444', 'schedule': '#f59e0b', 'delegate': '#10b981', 'eliminate': '#3b82f6' };
      
      Object.entries(quadCounts).forEach(([quad, count]) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);';
        item.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 12px; height: 12px; border-radius: 3px; background: ${quadColors[quad]};"></div>
            <span>${quadNames[quad]}</span>
          </div>
          <strong>${count}</strong>
        `;
        quadBreakdown.appendChild(item);
      });
      
      // Top projects
      const topProj = document.getElementById('topProjects');
      topProj.innerHTML = '';
      const projects = store.getProjects().sort((a,b) => b.total - a.total).slice(0, 5);
      if (projects.length === 0) {
        topProj.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No projects yet</div>';
      } else {
        projects.forEach(p => {
          const item = document.createElement('div');
          item.style.cssText = 'padding: 8px 0; border-bottom: 1px solid var(--border);';
          item.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <strong>${p.name}</strong>
              <span style="color: var(--text-muted);">${p.completed}/${p.total}</span>
            </div>
            <div class="progress-bar" style="height: 6px;">
              <div class="progress-fill" style="width: ${p.total ? (p.completed/p.total*100) : 0}%"></div>
            </div>
          `;
          topProj.appendChild(item);
        });
      }
      
      // Aging tasks
      const agingDiv = document.getElementById('agingTasks');
      agingDiv.innerHTML = '';
      const agingTasks = tasks.filter(t => !t.completed && daysSince(t.lastTouched) >= 14);
      if (agingTasks.length === 0) {
        agingDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--success);">‚úì No stale tasks! Great job staying on top of things.</div>';
      } else {
        agingTasks.forEach(t => {
          const item = document.createElement('div');
          item.style.cssText = 'padding: 12px; background: var(--warning-light); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--warning); cursor: pointer;';
          item.innerHTML = `
            <div style="font-weight: 600;">${t.title}</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Untouched for ${daysSince(t.lastTouched)} days</div>
          `;
          item.onclick = () => openTaskModal(t);
          agingDiv.appendChild(item);
        });
      }
    }

    // Modal
    function openTaskModal(task = null) {
      currentEditingTask = task;
      document.getElementById('modalTitle').textContent = task ? 'Edit Task' : 'New Task';
      document.getElementById('taskId').value = task ? task.id : '';
      document.getElementById('taskTitle').value = task ? task.title : '';
      document.getElementById('taskDescription').value = task ? task.description : '';
      document.getElementById('taskEstimate').value = task ? task.estimatedMinutes : '';
      document.getElementById('taskDue').value = task ? task.due : '';
      document.getElementById('taskQuadrant').value = task ? task.quadrant : 'do-first';
      document.getElementById('taskProject').value = task ? task.project : '';
      
      // Clear inputs
      document.getElementById('newTag').value = '';
      document.getElementById('newSubtask').value = '';
      
      const tagsContainer = document.getElementById('taskTags');
      tagsContainer.innerHTML = '';
      if (task && task.tags && task.tags.length > 0) {
        task.tags.forEach(tag => {
          const chip = document.createElement('span');
          chip.className = 'tag-chip';
          const btn = document.createElement('button');
          btn.textContent = '√ó';
          btn.onclick = () => {
            const updatedTags = task.tags.filter(t => t !== tag);
            store.updateTask(task.id, { tags: updatedTags });
            currentEditingTask.tags = updatedTags;
            openTaskModal(currentEditingTask);
          };
          chip.textContent = tag + ' ';
          chip.appendChild(btn);
          tagsContainer.appendChild(chip);
        });
      }
      
      const subtasksList = document.getElementById('subtasksList');
      subtasksList.innerHTML = '';
      if (task && task.subtasks && task.subtasks.length > 0) {
        task.subtasks.forEach(st => {
          const item = document.createElement('div');
          item.className = 'subtask-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = st.completed;
          checkbox.onchange = (e) => {
            store.toggleSubtask(task.id, st.id);
            const updatedTask = store.tasks[task.id];
            currentEditingTask = updatedTask;
            openTaskModal(updatedTask);
          };
          item.appendChild(checkbox);
          
          const input = document.createElement('input');
          input.type = 'text';
          input.value = st.title;
          input.readOnly = true;
          item.appendChild(input);
          
          const btn = document.createElement('button');
          btn.textContent = '√ó';
          btn.onclick = () => {
            const updatedSubtasks = task.subtasks.filter(s => s.id !== st.id);
            store.updateTask(task.id, { subtasks: updatedSubtasks });
            currentEditingTask.subtasks = updatedSubtasks;
            openTaskModal(currentEditingTask);
          };
          item.appendChild(btn);
          
          subtasksList.appendChild(item);
        });
      }
      
      document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';
      document.getElementById('taskModal').classList.add('open');
      
      // Focus title input
      setTimeout(() => document.getElementById('taskTitle').focus(), 100);
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('open');
      currentEditingTask = null;
    }

    function saveTask() {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) { 
        alert('‚ö†Ô∏è Task title is required');
        document.getElementById('taskTitle').focus();
        return; 
      }
      
      const data = {
        title,
        description: document.getElementById('taskDescription').value.trim(),
        estimatedMinutes: parseInt(document.getElementById('taskEstimate').value) || 0,
        due: document.getElementById('taskDue').value,
        quadrant: document.getElementById('taskQuadrant').value,
        project: document.getElementById('taskProject').value.trim()
      };
      
      if (currentEditingTask) {
        // Preserve existing tags and subtasks
        data.tags = currentEditingTask.tags || [];
        data.subtasks = currentEditingTask.subtasks || [];
        data.totalMinutes = currentEditingTask.totalMinutes || 0;
        store.updateTask(currentEditingTask.id, data);
      } else {
        store.addTask(data);
      }
      
      closeTaskModal();
      render();
    }

    // Event listeners
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        currentView = item.dataset.view;
        document.querySelectorAll('#contentArea > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(currentView + 'View').classList.remove('hidden');
        
        // Render insights when switching to that view
        if (currentView === 'insights') {
          renderInsights();
        }
      });
    });

    document.getElementById('newTaskBtn').addEventListener('click', () => openTaskModal());
    document.getElementById('modalClose').addEventListener('click', closeTaskModal);
    document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
    document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
    document.getElementById('deleteTaskBtn').addEventListener('click', () => {
      if (!currentEditingTask || !confirm('Delete this task?')) return;
      store.deleteTask(currentEditingTask.id);
      closeTaskModal();
      render();
    });

    document.getElementById('addTagBtn').addEventListener('click', () => {
      if (!currentEditingTask) {
        alert('‚ö†Ô∏è Please save the task first before adding tags');
        return;
      }
      const tag = document.getElementById('newTag').value.trim();
      if (!tag) {
        alert('‚ö†Ô∏è Please enter a tag name');
        return;
      }
      const updatedTags = [...(currentEditingTask.tags || []), tag];
      store.updateTask(currentEditingTask.id, { tags: updatedTags });
      currentEditingTask.tags = updatedTags;
      document.getElementById('newTag').value = '';
      openTaskModal(currentEditingTask);
    });

    document.getElementById('newTag').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addTagBtn').click();
      }
    });

    document.getElementById('addSubtaskBtn').addEventListener('click', () => {
      if (!currentEditingTask) {
        alert('‚ö†Ô∏è Please save the task first before adding subtasks');
        return;
      }
      const title = document.getElementById('newSubtask').value.trim();
      if (!title) {
        alert('‚ö†Ô∏è Please enter a subtask title');
        return;
      }
      const st = { id: 'st-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9), title, completed: false };
      const updatedSubtasks = [...(currentEditingTask.subtasks || []), st];
      store.updateTask(currentEditingTask.id, { subtasks: updatedSubtasks });
      currentEditingTask.subtasks = updatedSubtasks;
      document.getElementById('newSubtask').value = '';
      openTaskModal(currentEditingTask);
    });

    document.getElementById('newSubtask').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addSubtaskBtn').click();
      }
    });

    document.getElementById('timerStart').addEventListener('click', () => timer.start());
    document.getElementById('timerPause').addEventListener('click', () => timer.pause());
    document.getElementById('timerReset').addEventListener('click', () => timer.reset());
    document.getElementById('timerMinimize').addEventListener('click', () => {
      const float = document.getElementById('timerFloat');
      float.classList.toggle('minimized');
      document.querySelector('.timer-content').classList.toggle('hidden');
      document.getElementById('timerMinimizedContent').classList.toggle('hidden');
    });

    document.getElementById('autoPrioritizeBtn').addEventListener('click', () => {
      const tasks = store.getAll().filter(t => !t.completed);
      if (tasks.length === 0) {
        alert('‚úì No active tasks to prioritize!\n\nYou\'re all caught up.');
        return;
      }
      const scored = tasks.map(t => ({
        task: t,
        score: store.calculatePriorityScore(t)
      })).sort((a, b) => b.score - a.score);
      
      const top3 = scored.slice(0, 3);
      const message = 'Auto-Prioritized Successfully\n\nTop 3 priorities:\n\n' + 
        top3.map((item, i) => `${i + 1}. ${item.task.title} (score: ${item.score})`).join('\n');
      
      alert(message);
      render();
    });

    document.getElementById('refreshPriority').addEventListener('click', () => {
      render();
    });

    // Search/Command palette
    let commandPaletteOpen = false;
    
    document.getElementById('searchInput').addEventListener('focus', (e) => {
      e.target.blur(); // Don't keep focus on search bar
      document.getElementById('commandPalette').classList.add('open');
      document.getElementById('commandInput').focus();
      commandPaletteOpen = true;
    });

    document.getElementById('commandInput').addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      const results = document.getElementById('commandResults');
      results.innerHTML = '';
      
      if (!query) {
        results.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Type to search tasks or create new...</div>';
        return;
      }
      
      // Search tasks
      const tasks = store.getAll();
      const matches = tasks.filter(t => 
        t.title.toLowerCase().includes(query) || 
        (t.description && t.description.toLowerCase().includes(query)) ||
        (t.project && t.project.toLowerCase().includes(query))
      ).slice(0, 5);
      
      if (matches.length > 0) {
        matches.forEach(task => {
          const item = document.createElement('div');
          item.className = 'command-item';
          item.innerHTML = `
            <span style="font-size: 20px;">${task.completed ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>'}</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${task.title}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${task.project || task.quadrant}</div>
            </div>
          `;
          item.onclick = () => {
            document.getElementById('commandPalette').classList.remove('open');
            commandPaletteOpen = false;
            openTaskModal(task);
          };
          results.appendChild(item);
        });
      }
      
      // Option to create new task
      const createItem = document.createElement('div');
      createItem.className = 'command-item';
      createItem.innerHTML = `
        <span style="font-size: 20px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 14px;">Create: "${query}"</div>
          <div style="font-size: 12px; color: var(--text-muted);">Press Enter to create new task</div>
        </div>
      `;
      createItem.onclick = () => {
        const id = store.addTask({ title: query });
        document.getElementById('commandPalette').classList.remove('open');
        commandPaletteOpen = false;
        render();
        openTaskModal(store.tasks[id]);
      };
      results.appendChild(createItem);
    });

    document.getElementById('commandInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
          const id = store.addTask({ title: query });
          document.getElementById('commandPalette').classList.remove('open');
          commandPaletteOpen = false;
          document.getElementById('commandInput').value = '';
          render();
          openTaskModal(store.tasks[id]);
        }
      }
    });

    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K for command palette
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('commandPalette').classList.add('open');
        document.getElementById('commandInput').focus();
        document.getElementById('commandInput').value = '';
        commandPaletteOpen = true;
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        closeTaskModal();
        if (commandPaletteOpen) {
          document.getElementById('commandPalette').classList.remove('open');
          document.getElementById('commandInput').value = '';
          commandPaletteOpen = false;
        }
      }
      
      // Cmd/Ctrl + N for new task
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault();
        openTaskModal();
      }
    });

    document.getElementById('commandPalette').addEventListener('click', (e) => {
      if (e.target.id === 'commandPalette') {
        document.getElementById('commandPalette').classList.remove('open');
        document.getElementById('commandInput').value = '';
        commandPaletteOpen = false;
      }
    });

    document.getElementById('taskModal').addEventListener('click', (e) => {
      if (e.target.id === 'taskModal') {
        closeTaskModal();
      }
    });

    // Init with better demo data
    if (Object.keys(store.tasks).length === 0) {
      const welcomeId = store.addTask({ 
        title: 'Welcome to PrioBox', 
        description: 'Click me to edit and explore features',
        quadrant: 'do-first', 
        estimatedMinutes: 5,
        tags: ['getting-started']
      });
      
      store.addTask({ 
        title: 'Try the Focus Timer', 
        description: 'Click the timer in the bottom-right to start a focus session',
        quadrant: 'do-first', 
        estimatedMinutes: 25,
        tags: ['productivity']
      });
      
      const planId = store.addTask({ 
        title: 'Plan your week', 
        description: 'Break this down into smaller subtasks',
        quadrant: 'schedule', 
        estimatedMinutes: 30,
        project: 'Planning'
      });
      
      // Add subtasks to demo
      store.updateTask(planId, {
        subtasks: [
          { id: 'st-1', title: 'Review last week', completed: false },
          { id: 'st-2', title: 'Set 3 main goals', completed: false },
          { id: 'st-3', title: 'Schedule important tasks', completed: false }
        ]
      });
      
      store.addTask({
        title: 'Explore keyboard shortcuts',
        description: 'Try Cmd/Ctrl+K for quick search, Cmd/Ctrl+N for new task',
        quadrant: 'schedule',
        estimatedMinutes: 5,
        tags: ['tips']
      });
    }

    render();
    timer.updateDisplay();
  </script>
</body>
</html>
