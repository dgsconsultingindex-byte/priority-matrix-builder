<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrioBox ‚Äî Focus What Matters</title>
  <style>
    :root {
      --bg: #fafbfc;
      --panel: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: #eff6ff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --sidebar-width: 240px;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow: hidden; }
    .app-container { display: flex; height: 100vh; }
    
    /* Sidebar */
    .sidebar { width: var(--sidebar-width); background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
    .logo { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .logo h1 { margin: 0; font-size: 20px; font-weight: 700; }
    .nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; font-size: 14px; font-weight: 500; color: var(--text-muted); }
    .nav-item:hover { background: var(--bg); color: var(--text); }
    .nav-item.active { background: var(--accent-light); color: var(--accent); border-left-color: var(--accent); }
    .nav-icon { font-size: 18px; width: 24px; text-align: center; }
    .nav-badge { margin-left: auto; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    
    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar { background: var(--panel); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow-sm); }
    .search-bar { flex: 1; max-width: 500px; position: relative; }
    .search-bar input { width: 100%; padding: 10px 40px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
    .search-bar input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .search-kbd { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--text-muted); background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }
    .btn { padding: 10px 18px; border: 1px solid var(--border); background: var(--panel); color: var(--text); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { background: var(--bg); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-icon { padding: 10px; }
    .content-area { flex: 1; overflow-y: auto; padding: 24px; }
    
    /* Stats */
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-mini { background: var(--panel); padding: 16px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
    .stat-mini:hover { box-shadow: var(--shadow-md); }
    .stat-mini-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-mini-value { font-size: 24px; font-weight: 700; }
    .stat-mini-icon { font-size: 32px; opacity: 0.3; }
    
    /* Section */
    .section { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
    .section-header { padding: 16px 20px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .section-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .section-actions { display: flex; gap: 8px; }
    .section-content { padding: 16px; }
    
    /* Tasks */
    .task-list { display: flex; flex-direction: column; gap: 8px; }
    .task { background: var(--panel); padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: flex-start; gap: 12px; transition: all 0.2s; cursor: pointer; }
    .task:hover { box-shadow: var(--shadow-md); border-color: var(--accent); transform: translateX(2px); }
    .task.completed { opacity: 0.6; }
    .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .task-checkbox:hover { border-color: var(--success); background: #d1fae5; }
    .task-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
    .task-main { flex: 1; min-width: 0; }
    .task-title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .aging-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .aging-dot.fresh { background: var(--success); }
    .aging-dot.aging { background: var(--warning); }
    .aging-dot.stale { background: var(--danger); animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .task-title { font-weight: 600; font-size: 14px; flex: 1; }
    .task.completed .task-title { text-decoration: line-through; }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); align-items: center; }
    .task-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: var(--bg); }
    .task-badge.project { background: #e0e7ff; color: #4338ca; }
    .task-badge.tag { background: #fef3c7; color: #92400e; }
    .task-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
    .task:hover .task-actions { opacity: 1; }
    .task-action-btn { padding: 6px 8px; background: transparent; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; transition: all 0.2s; color: var(--text-muted); }
    .task-action-btn:hover { background: var(--bg); color: var(--text); }
    .progress-bar { width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: var(--success); transition: width 0.3s ease; }
    
    /* Matrix */
    .matrix-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .quadrant { background: var(--panel); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .quadrant-header { padding: 14px 16px; font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .quadrant.do-first { border-top: 3px solid var(--danger); }
    .quadrant.schedule { border-top: 3px solid var(--warning); }
    .quadrant.delegate { border-top: 3px solid var(--success); }
    .quadrant.eliminate { border-top: 3px solid var(--accent); }
    .quadrant-content { padding: 12px; min-height: 200px; }
    .quadrant-count { background: var(--bg); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    
    /* Timer */
    .timer-float { position: fixed; bottom: 24px; right: 24px; background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-lg); color: white; min-width: 280px; z-index: 100; transition: all 0.3s; }
    .timer-float.minimized { min-width: auto; padding: 16px; cursor: pointer; }
    .timer-float.minimized .timer-content { display: none; }
    .timer-display { font-size: 36px; font-weight: 700; text-align: center; margin: 12px 0; font-variant-numeric: tabular-nums; }
    .timer-controls { display: flex; gap: 8px; justify-content: center; }
    .timer-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .timer-btn:hover { background: rgba(255,255,255,0.3); }
    .timer-info { text-align: center; margin-top: 12px; font-size: 13px; opacity: 0.9; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--panel); border-radius: 16px; box-shadow: var(--shadow-lg); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; animation: modalIn 0.2s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 20px; font-weight: 700; margin: 0; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
    .form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
    .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    textarea.form-input { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; gap: 10px; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 64px; opacity: 0.3; margin-bottom: 16px; }
    .hidden { display: none !important; }
    
    /* Command Palette */
    .command-palette { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: var(--panel); border-radius: 12px; box-shadow: var(--shadow-lg); width: 90%; max-width: 600px; z-index: 2000; display: none; }
    .command-palette.open { display: block; animation: modalIn 0.2s ease; }
    .command-input { width: 100%; padding: 20px; border: none; font-size: 16px; border-bottom: 1px solid var(--border); }
    .command-input:focus { outline: none; }
    .command-results { max-height: 400px; overflow-y: auto; padding: 8px; }
    .command-item { padding: 12px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
    .command-item:hover { background: var(--accent-light); }
    
    .subtask-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; margin-bottom: 6px; background: var(--bg); }
    .tags-container { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
    .tag-chip { background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .tag-chip button { background: none; border: none; padding: 0; cursor: pointer; color: inherit; font-size: 14px; line-height: 1; }
    
    .project-card { background: var(--bg); padding: 16px; border-radius: 10px; margin-bottom: 12px; border: 1px solid var(--border); }
    .project-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .project-name { font-weight: 700; font-size: 16px; }
    .history-item { padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--success); }
    
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -240px; top: 0; bottom: 0; z-index: 999; transition: left 0.3s; }
      .sidebar.open { left: 0; }
      .matrix-grid { grid-template-columns: 1fr; }
      .timer-float { bottom: 16px; right: 16px; min-width: 220px; }
      .search-kbd { display: none; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <svg width="32" height="32" viewBox="0 0 100 100">
          <rect x="8" y="8" width="38" height="38" rx="6" fill="#ef4444"/>
          <rect x="54" y="8" width="38" height="38" rx="6" fill="#f59e0b"/>
          <rect x="8" y="54" width="38" height="38" rx="6" fill="#10b981"/>
          <rect x="54" y="54" width="38" height="38" rx="6" fill="#3b82f6"/>
        </svg>
        <h1>PrioBox</h1>
      </div>
      <nav class="nav">
        <div class="nav-item active" data-view="dashboard"><span class="nav-icon">üìä</span><span>Dashboard</span></div>
        <div class="nav-item" data-view="focus"><span class="nav-icon">üéØ</span><span>Focus Mode</span><span class="nav-badge" id="focusCount">0</span></div>
        <div class="nav-item" data-view="matrix"><span class="nav-icon">üìà</span><span>Matrix View</span></div>
        <div class="nav-item" data-view="projects"><span class="nav-icon">üìÅ</span><span>Projects</span></div>
        <div class="nav-item" data-view="history"><span class="nav-icon">üèÜ</span><span>Completed</span></div>
        <div class="nav-item" data-view="insights"><span class="nav-icon">üìâ</span><span>Insights</span></div>
      </nav>
      <div class="sidebar-footer">
        <button class="btn btn-primary" style="width: 100%;" id="newTaskBtn"><span>‚ûï</span><span>New Task</span></button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div class="search-bar">
          <span class="search-icon">üîç</span>
          <input type="text" placeholder="Search tasks or quick add..." id="searchInput">
          <span class="search-kbd">‚åòK</span>
        </div>
        <button class="btn" id="autoPrioritizeBtn"><span>‚ú®</span><span>Auto-Prioritize</span></button>
        <button class="btn btn-icon" id="filterBtn" title="Filter">üîΩ</button>
      </div>

      <div class="content-area" id="contentArea">
        <!-- Dashboard View -->
        <div id="dashboardView">
          <div class="stats-bar">
            <div class="stat-mini">
              <div><div class="stat-mini-label">Today's Focus</div><div class="stat-mini-value" id="todayCount">0</div></div>
              <div class="stat-mini-icon">üéØ</div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Consistency</div><div class="stat-mini-value" id="streakValue">0/7</div></div>
              <div class="stat-mini-icon">üî•</div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Completed Today</div><div class="stat-mini-value" id="completedToday">0</div></div>
              <div class="stat-mini-icon">‚úÖ</div>
            </div>
            <div class="stat-mini">
              <div><div class="stat-mini-label">Stale Tasks</div><div class="stat-mini-value" id="staleCount">0</div></div>
              <div class="stat-mini-icon">‚ö†Ô∏è</div>
            </div>
          </div>

          <div class="section">
            <div class="section-header">
              <div class="section-title"><span>‚ö°</span><span>Smart Priority Queue</span></div>
              <div class="section-actions"><button class="btn btn-icon" id="refreshPriority">‚Üª</button></div>
            </div>
            <div class="section-content"><div class="task-list" id="priorityQueue"></div></div>
          </div>

          <div class="section">
            <div class="section-header"><div class="section-title"><span>üìä</span><span>Matrix Overview</span></div></div>
            <div class="section-content">
              <div class="matrix-grid">
                <div class="quadrant do-first">
                  <div class="quadrant-header"><span>üî• Do First</span><span class="quadrant-count" id="countDoFirst">0</span></div>
                  <div class="quadrant-content"><div class="task-list" id="quickDoFirst"></div></div>
                </div>
                <div class="quadrant schedule">
                  <div class="quadrant-header"><span>üìÖ Schedule</span><span class="quadrant-count" id="countSchedule">0</span></div>
                  <div class="quadrant-content"><div class="task-list" id="quickSchedule"></div></div>
                </div>
                <div class="quadrant delegate">
                  <div class="quadrant-header"><span>üë• Delegate</span><span class="quadrant-count" id="countDelegate">0</span></div>
                  <div class="quadrant-content"><div class="task-list" id="quickDelegate"></div></div>
                </div>
                <div class="quadrant eliminate">
                  <div class="quadrant-header"><span>üóëÔ∏è Eliminate</span><span class="quadrant-count" id="countEliminate">0</span></div>
                  <div class="quadrant-content"><div class="task-list" id="quickEliminate"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Focus Mode -->
        <div id="focusView" class="hidden">
          <div class="section">
            <div class="section-header"><div class="section-title"><span>üéØ</span><span>Today's Focus</span></div></div>
            <div class="section-content"><div class="task-list" id="focusList"></div></div>
          </div>
        </div>

        <!-- Matrix View -->
        <div id="matrixView" class="hidden">
          <div class="matrix-grid">
            <div class="quadrant do-first">
              <div class="quadrant-header"><span>üî• Do First</span><span class="quadrant-count" id="fullCountDoFirst">0</span></div>
              <div class="quadrant-content"><div class="task-list" id="fullDoFirst"></div></div>
            </div>
            <div class="quadrant schedule">
              <div class="quadrant-header"><span>üìÖ Schedule</span><span class="quadrant-count" id="fullCountSchedule">0</span></div>
              <div class="quadrant-content"><div class="task-list" id="fullSchedule"></div></div>
            </div>
            <div class="quadrant delegate">
              <div class="quadrant-header"><span>üë• Delegate</span><span class="quadrant-count" id="fullCountDelegate">0</span></div>
              <div class="quadrant-content"><div class="task-list" id="fullDelegate"></div></div>
            </div>
            <div class="quadrant eliminate">
              <div class="quadrant-header"><span>üóëÔ∏è Eliminate</span><span class="quadrant-count" id="fullCountEliminate">0</span></div>
              <div class="quadrant-content"><div class="task-list" id="fullEliminate"></div></div>
            </div>
          </div>
        </div>

        <!-- Projects View -->
        <div id="projectsView" class="hidden">
          <div class="section">
            <div class="section-header"><div class="section-title"><span>üìÅ</span><span>Projects</span></div></div>
            <div class="section-content" id="projectsList"></div>
          </div>
        </div>

        <!-- History View -->
        <div id="historyView" class="hidden">
          <div class="section">
            <div class="section-header"><div class="section-title"><span>üèÜ</span><span>Completed Tasks</span></div></div>
            <div class="section-content" id="historyList"></div>
          </div>
        </div>

        <!-- Insights View -->
        <div id="insightsView" class="hidden">
          <div class="section">
            <div class="section-header"><div class="section-title"><span>üìâ</span><span>Productivity Insights</span></div></div>
            <div class="section-content"><p style="text-align: center; color: var(--text-muted); padding: 40px;">Insights coming soon...</p></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Timer -->
  <div class="timer-float" id="timerFloat">
    <div class="timer-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <span style="font-weight: 600;">Focus Timer</span>
        <button class="timer-btn" style="padding: 4px 8px; font-size: 11px;" id="timerMinimize">‚àí</button>
      </div>
      <div class="timer-display" id="timerDisplay">25:00</div>
      <div class="timer-controls">
        <button class="timer-btn" id="timerStart">‚ñ∂ Start</button>
        <button class="timer-btn hidden" id="timerPause">‚è∏ Pause</button>
        <button class="timer-btn" id="timerReset">‚Üª Reset</button>
      </div>
      <div class="timer-info">Sessions today: <strong id="sessionsToday">0</strong></div>
    </div>
    <div id="timerMinimizedContent" class="hidden">‚è± <span id="timerMinDisplay">25:00</span></div>
  </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">New Task</h3>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="taskId">
        <div class="form-group">
          <label class="form-label">Task Title *</label>
          <input class="form-input" id="taskTitle" placeholder="What needs to be done?">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="taskDescription" placeholder="Add details..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Estimated Minutes</label>
            <input class="form-input" id="taskEstimate" type="number" min="1" placeholder="30">
          </div>
          <div class="form-group">
            <label class="form-label">Due Date</label>
            <input class="form-input" id="taskDue" type="date">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Quadrant</label>
          <select class="form-input" id="taskQuadrant">
            <option value="do-first">üî• Do First (Urgent & Important)</option>
            <option value="schedule">üìÖ Schedule (Important, Not Urgent)</option>
            <option value="delegate">üë• Delegate (Urgent, Not Important)</option>
            <option value="eliminate">üóëÔ∏è Eliminate (Neither)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Project</label>
          <input class="form-input" id="taskProject" placeholder="e.g., Website Redesign">
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <div class="tags-container" id="taskTags"></div>
          <div style="display: flex; gap: 6px; margin-top: 8px;">
            <input class="form-input" id="newTag" placeholder="Add tag..." style="flex: 1;">
            <button class="btn" id="addTagBtn">+ Add</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Subtasks</label>
          <div id="subtasksList"></div>
          <div style="display: flex; gap: 6px; margin-top: 8px;">
            <input class="form-input" id="newSubtask" placeholder="Add subtask..." style="flex: 1;">
            <button class="btn" id="addSubtaskBtn">+ Add</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="deleteTaskBtn" style="background: var(--danger); color: white; border-color: var(--danger);">Delete</button>
        <div style="display: flex; gap: 10px;">
          <button class="btn" id="cancelTaskBtn">Cancel</button>
          <button class="btn btn-primary" id="saveTaskBtn">Save Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="command-palette" id="commandPalette">
    <input class="command-input" id="commandInput" placeholder="Type to search or create...">
    <div class="command-results" id="commandResults"></div>
  </div>

  <script>
    'use strict';

    // Store
    class TaskStore {
      constructor() {
        this.STORAGE_KEY = 'priobox_v4';
        this.PREFS_KEY = 'priobox_prefs_v4';
        this.tasks = {};
        this.prefs = { timerSessionsHistory: {}, completedHistory: {} };
        this.load();
      }
      load() {
        try {
          const t = localStorage.getItem(this.STORAGE_KEY);
          const p = localStorage.getItem(this.PREFS_KEY);
          if (t) this.tasks = JSON.parse(t);
          if (p) this.prefs = {...this.prefs, ...JSON.parse(p)};
        } catch(e) { console.error(e); }
      }
      save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.tasks)); }
      savePrefs() { localStorage.setItem(this.PREFS_KEY, JSON.stringify(this.prefs)); }
      addTask(data) {
        const id = 't-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        this.tasks[id] = {
          id, title: data.title || 'Untitled', description: data.description || '',
          due: data.due || '', quadrant: data.quadrant || 'do-first', completed: false,
          createdAt: Date.now(), estimatedMinutes: data.estimatedMinutes || 0,
          totalMinutes: 0, lastTouched: Date.now(), subtasks: data.subtasks || [],
          tags: data.tags || [], project: data.project || '', completedAt: null
        };
        this.save();
        return id;
      }
      updateTask(id, updates) {
        if (!this.tasks[id]) return false;
        this.tasks[id] = {...this.tasks[id], ...updates, lastTouched: Date.now()};
        this.save();
        return true;
      }
      deleteTask(id) { delete this.tasks[id]; this.save(); }
      toggleComplete(id) {
        const t = this.tasks[id];
        if (!t) return;
        t.completed = !t.completed;
        t.completedAt = t.completed ? Date.now() : null;
        t.lastTouched = Date.now();
        if (t.completed) {
          const d = new Date().toDateString();
          this.prefs.completedHistory[d] = (this.prefs.completedHistory[d]||0) + 1;
          this.savePrefs();
        }
        this.save();
      }
      getAll() {
        return Object.values(this.tasks).sort((a,b) => {
          if (a.completed !== b.completed) return a.completed ? 1 : -1;
          return b.createdAt - a.createdAt;
        });
      }
      calculatePriorityScore(task) {
        let score = 0;
        const now = Date.now();
        if (task.due) {
          const days = (new Date(task.due) - now) / (1000*60*60*24);
          if (days < 0) score += 40;
          else if (days < 1) score += 35;
          else if (days < 3) score += 25;
          else if (days < 7) score += 15;
        }
        if (task.estimatedMinutes > 0) {
          if (task.estimatedMinutes <= 15) score += 20;
          else if (task.estimatedMinutes <= 30) score += 15;
          else if (task.estimatedMinutes <= 60) score += 10;
          else score += 5;
        }
        const daysSince = (now - task.lastTouched) / (1000*60*60*24);
        if (daysSince < 1) score += 20;
        else if (daysSince < 3) score += 15;
        else if (daysSince < 7) score += 10;
        else if (daysSince >= 14) score -= 10;
        if (task.quadrant === 'do-first') score += 20;
        else if (task.quadrant === 'schedule') score += 10;
        else if (task.quadrant === 'delegate') score += 5;
        return score;
      }
      getProjects() {
        const projects = {};
        Object.values(this.tasks).forEach(t => {
          if (t.project) {
            if (!projects[t.project]) {
              projects[t.project] = { name: t.project, tasks: [], completed: 0, total: 0 };
            }
            projects[t.project].tasks.push(t);
            projects[t.project].total++;
            if (t.completed) projects[t.project].completed++;
          }
        });
        return Object.values(projects);
      }
    }

    const store = new TaskStore();
    let currentView = 'dashboard';
    let currentEditingTask = null;

    // Timer
    class Timer {
      constructor() {
        this.time = 25*60;
        this.running = false;
        this.interval = null;
      }
      start() {
        if (this.running) return;
        this.running = true;
        document.getElementById('timerStart').classList.add('hidden');
        document.getElementById('timerPause').classList.remove('hidden');
        this.interval = setInterval(() => {
          this.time--;
          this.updateDisplay();
          if (this.time <= 0) this.complete();
        }, 1000);
      }
      pause() {
        this.running = false;
        clearInterval(this.interval);
        document.getElementById('timerStart').classList.remove('hidden');
        document.getElementById('timerPause').classList.add('hidden');
      }
      reset() {
        this.pause();
        this.time = 25*60;
        this.updateDisplay();
      }
      complete() {
        this.pause();
        const d = new Date().toDateString();
        store.prefs.timerSessionsHistory[d] = (store.prefs.timerSessionsHistory[d]||0) + 1;
        store.savePrefs();
        alert('üéâ Focus session complete!');
        this.reset();
        render();
      }
      updateDisplay() {
        const m = String(Math.floor(this.time/60)).padStart(2,'0');
        const s = String(this.time%60).padStart(2,'0');
        const display = `${m}:${s}`;
        document.getElementById('timerDisplay').textContent = display;
        document.getElementById('timerMinDisplay').textContent = display;
      }
    }

    const timer = new Timer();

    // Utils
    function daysSince(ts) {
      return Math.floor((Date.now() - ts) / (1000*60*60*24));
    }
    function getAgingStatus(ts) {
      const d = daysSince(ts);
      if (d < 3) return 'fresh';
      if (d < 7) return 'aging';
      return 'stale';
    }
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const today = new Date();
      today.setHours(0,0,0,0);
      d.setHours(0,0,0,0);
      const diff = (d - today) / (1000*60*60*24);
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Tomorrow';
      if (diff < 0) return `${Math.abs(diff)}d overdue`;
      return `In ${diff}d`;
    }
    function formatRelativeTime(ts) {
      const mins = Math.floor((Date.now() - ts) / (1000*60));
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return new Date(ts).toLocaleDateString();
    }

    // Task Element
    function createTaskElement(task) {
      const el = document.createElement('div');
      el.className = 'task' + (task.completed ? ' completed' : '');
      
      const checkbox = document.createElement('div');
      checkbox.className = 'task-checkbox' + (task.completed ? ' checked' : '');
      if (task.completed) checkbox.textContent = '‚úì';
      checkbox.onclick = (e) => { e.stopPropagation(); store.toggleComplete(task.id); render(); };
      el.appendChild(checkbox);
      
      const main = document.createElement('div');
      main.className = 'task-main';
      
      const titleRow = document.createElement('div');
      titleRow.className = 'task-title-row';
      
      const dot = document.createElement('span');
      dot.className = 'aging-dot ' + getAgingStatus(task.lastTouched);
      titleRow.appendChild(dot);
      
      const title = document.createElement('span');
      title.className = 'task-title';
      title.textContent = task.title;
      titleRow.appendChild(title);
      
      main.appendChild(titleRow);
      
      const meta = document.createElement('div');
      meta.className = 'task-meta';
      
      if (task.project) {
        const badge = document.createElement('span');
        badge.className = 'task-badge project';
        badge.textContent = 'üìÅ ' + task.project;
        meta.appendChild(badge);
      }
      
      if (task.tags && task.tags.length > 0) {
        task.tags.forEach(tag => {
          const badge = document.createElement('span');
          badge.className = 'task-badge tag';
          badge.textContent = '#' + tag;
          meta.appendChild(badge);
        });
      }
      
      if (task.subtasks && task.subtasks.length > 0) {
        const completed = task.subtasks.filter(st => st.completed).length;
        const span = document.createElement('span');
        span.textContent = `‚úì ${completed}/${task.subtasks.length}`;
        meta.appendChild(span);
      }
      
      if (task.estimatedMinutes) {
        const span = document.createElement('span');
        span.textContent = `‚è± ${task.estimatedMinutes}m`;
        meta.appendChild(span);
      }
      
      if (task.due) {
        const span = document.createElement('span');
        span.textContent = 'üìÖ ' + formatDate(task.due);
        const isOverdue = new Date(task.due) < new Date() && !task.completed;
        if (isOverdue) span.style.color = 'var(--danger)';
        meta.appendChild(span);
      }
      
      main.appendChild(meta);
      
      if (task.subtasks && task.subtasks.length > 0) {
        const prog = document.createElement('div');
        prog.className = 'progress-bar';
        const fill = document.createElement('div');
        fill.className = 'progress-fill';
        const completed = task.subtasks.filter(st => st.completed).length;
        fill.style.width = (completed / task.subtasks.length * 100) + '%';
        prog.appendChild(fill);
        main.appendChild(prog);
      }
      
      el.appendChild(main);
      
      const actions = document.createElement('div');
      actions.className = 'task-actions';
      
      const editBtn = document.createElement('button');
      editBtn.className = 'task-action-btn';
      editBtn.textContent = '‚úé';
      editBtn.title = 'Edit';
      editBtn.onclick = (e) => { e.stopPropagation(); openTaskModal(task); };
      actions.appendChild(editBtn);
      
      el.appendChild(actions);
      el.onclick = () => openTaskModal(task);
      
      return el;
    }

    // Render
    function render() {
      const tasks = store.getAll();
      const incomplete = tasks.filter(t => !t.completed);
      
      // Stats
      const today = new Date().toDateString();
      const completedToday = store.prefs.completedHistory[today] || 0;
      document.getElementById('completedToday').textContent = completedToday;
      
      const stale = incomplete.filter(t => daysSince(t.lastTouched) >= 14).length;
      document.getElementById('staleCount').textContent = stale;
      
      let consistent = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const ds = d.toDateString();
        const c = store.prefs.completedHistory[ds] || 0;
        const s = store.prefs.timerSessionsHistory[ds] || 0;
        if (c >= 3 || s >= 1) consistent++;
      }
      document.getElementById('streakValue').textContent = `${consistent}/7`;
      
      const sessions = store.prefs.timerSessionsHistory[today] || 0;
      document.getElementById('sessionsToday').textContent = sessions;
      
      // Priority Queue
      const scored = incomplete.map(t => ({ task: t, score: store.calculatePriorityScore(t) }))
        .sort((a,b) => b.score - a.score).slice(0, 5);
      const pq = document.getElementById('priorityQueue');
      pq.innerHTML = '';
      if (scored.length === 0) {
        pq.innerHTML = '<div class="empty-state"><div class="empty-icon">üéâ</div><div>All caught up!</div></div>';
      } else {
        scored.forEach(({task}) => pq.appendChild(createTaskElement(task)));
      }
      
      document.getElementById('todayCount').textContent = scored.length;
      document.getElementById('focusCount').textContent = scored.length;
      
      // Matrix
      ['do-first', 'schedule', 'delegate', 'eliminate'].forEach(q => {
        const qTasks = incomplete.filter(t => t.quadrant === q);
        document.getElementById('count' + q.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join('')).textContent = qTasks.length;
        document.getElementById('fullCount' + q.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join('')).textContent = qTasks.length;
        
        const quickList = document.getElementById('quick' + q.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(''));
        quickList.innerHTML = '';
        qTasks.slice(0, 3).forEach(t => quickList.appendChild(createTaskElement(t)));
        
        const fullList = document.getElementById('full' + q.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(''));
        fullList.innerHTML = '';
        if (qTasks.length === 0) {
          fullList.innerHTML = '<div class="empty-state" style="padding: 20px;"><div style="opacity: 0.5;">No tasks</div></div>';
        } else {
          qTasks.forEach(t => fullList.appendChild(createTaskElement(t)));
        }
      });
      
      // Focus view
      const focusList = document.getElementById('focusList');
      focusList.innerHTML = '';
      if (scored.length === 0) {
        focusList.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><div>No focus tasks. Great job!</div></div>';
      } else {
        scored.forEach(({task}) => focusList.appendChild(createTaskElement(task)));
      }
      
      // Projects
      const projects = store.getProjects();
      const projList = document.getElementById('projectsList');
      projList.innerHTML = '';
      if (projects.length === 0) {
        projList.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÅ</div><div>No projects yet</div></div>';
      } else {
        projects.forEach(p => {
          const card = document.createElement('div');
          card.className = 'project-card';
          card.innerHTML = `
            <div class="project-header">
              <div class="project-name">${p.name}</div>
              <div>${p.completed}/${p.total}</div>
            </div>
            <div class="progress-bar" style="margin-bottom: 12px;">
              <div class="progress-fill" style="width: ${p.total ? p.completed/p.total*100 : 0}%"></div>
            </div>
          `;
          projList.appendChild(card);
        });
      }
      
      // History
      const completed = tasks.filter(t => t.completed && t.completedAt).sort((a,b) => b.completedAt - a.completedAt);
      const histList = document.getElementById('historyList');
      histList.innerHTML = '';
      if (completed.length === 0) {
        histList.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><div>No completed tasks yet</div></div>';
      } else {
        completed.forEach(t => {
          const item = document.createElement('div');
          item.className = 'history-item';
          item.innerHTML = `
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${formatRelativeTime(t.completedAt)}</div>
            <div style="font-weight: 600;">${t.title}</div>
          `;
          histList.appendChild(item);
        });
      }
    }

    // Modal
    function openTaskModal(task = null) {
      currentEditingTask = task;
      document.getElementById('modalTitle').textContent = task ? 'Edit Task' : 'New Task';
      document.getElementById('taskId').value = task ? task.id : '';
      document.getElementById('taskTitle').value = task ? task.title : '';
      document.getElementById('taskDescription').value = task ? task.description : '';
      document.getElementById('taskEstimate').value = task ? task.estimatedMinutes : '';
      document.getElementById('taskDue').value = task ? task.due : '';
      document.getElementById('taskQuadrant').value = task ? task.quadrant : 'do-first';
      document.getElementById('taskProject').value = task ? task.project : '';
      
      const tagsContainer = document.getElementById('taskTags');
      tagsContainer.innerHTML = '';
      if (task && task.tags) {
        task.tags.forEach(tag => {
          const chip = document.createElement('span');
          chip.className = 'tag-chip';
          chip.innerHTML = `${tag} <button>√ó</button>`;
          chip.querySelector('button').onclick = () => {
            task.tags = task.tags.filter(t => t !== tag);
            store.updateTask(task.id, { tags: task.tags });
            openTaskModal(task);
          };
          tagsContainer.appendChild(chip);
        });
      }
      
      const subtasksList = document.getElementById('subtasksList');
      subtasksList.innerHTML = '';
      if (task && task.subtasks) {
        task.subtasks.forEach(st => {
          const item = document.createElement('div');
          item.className = 'subtask-item';
          item.innerHTML = `
            <input type="checkbox" ${st.completed ? 'checked' : ''}>
            <input type="text" value="${st.title}" readonly>
            <button>√ó</button>
          `;
          item.querySelector('input[type="checkbox"]').onchange = (e) => {
            st.completed = e.target.checked;
            store.updateTask(task.id, { subtasks: task.subtasks });
            openTaskModal(task);
          };
          item.querySelector('button').onclick = () => {
            task.subtasks = task.subtasks.filter(s => s.id !== st.id);
            store.updateTask(task.id, { subtasks: task.subtasks });
            openTaskModal(task);
          };
          subtasksList.appendChild(item);
        });
      }
      
      document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';
      document.getElementById('taskModal').classList.add('open');
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('open');
      currentEditingTask = null;
    }

    function saveTask() {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) { alert('Title required'); return; }
      
      const data = {
        title,
        description: document.getElementById('taskDescription').value,
        estimatedMinutes: parseInt(document.getElementById('taskEstimate').value) || 0,
        due: document.getElementById('taskDue').value,
        quadrant: document.getElementById('taskQuadrant').value,
        project: document.getElementById('taskProject').value.trim()
      };
      
      if (currentEditingTask) {
        data.tags = currentEditingTask.tags || [];
        data.subtasks = currentEditingTask.subtasks || [];
        store.updateTask(currentEditingTask.id, data);
      } else {
        store.addTask(data);
      }
      
      closeTaskModal();
      render();
    }

    // Event listeners
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        currentView = item.dataset.view;
        document.querySelectorAll('#contentArea > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(currentView + 'View').classList.remove('hidden');
      });
    });

    document.getElementById('newTaskBtn').addEventListener('click', () => openTaskModal());
    document.getElementById('modalClose').addEventListener('click', closeTaskModal);
    document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);
    document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
    document.getElementById('deleteTaskBtn').addEventListener('click', () => {
      if (!currentEditingTask || !confirm('Delete this task?')) return;
      store.deleteTask(currentEditingTask.id);
      closeTaskModal();
      render();
    });

    document.getElementById('addTagBtn').addEventListener('click', () => {
      if (!currentEditingTask) return;
      const tag = document.getElementById('newTag').value.trim();
      if (!tag) return;
      currentEditingTask.tags = [...(currentEditingTask.tags || []), tag];
      store.updateTask(currentEditingTask.id, { tags: currentEditingTask.tags });
      document.getElementById('newTag').value = '';
      openTaskModal(currentEditingTask);
    });

    document.getElementById('addSubtaskBtn').addEventListener('click', () => {
      if (!currentEditingTask) return;
      const title = document.getElementById('newSubtask').value.trim();
      if (!title) return;
      const st = { id: 'st-' + Date.now(), title, completed: false };
      currentEditingTask.subtasks = [...(currentEditingTask.subtasks || []), st];
      store.updateTask(currentEditingTask.id, { subtasks: currentEditingTask.subtasks });
      document.getElementById('newSubtask').value = '';
      openTaskModal(currentEditingTask);
    });

    document.getElementById('timerStart').addEventListener('click', () => timer.start());
    document.getElementById('timerPause').addEventListener('click', () => timer.pause());
    document.getElementById('timerReset').addEventListener('click', () => timer.reset());
    document.getElementById('timerMinimize').addEventListener('click', () => {
      const float = document.getElementById('timerFloat');
      float.classList.toggle('minimized');
      document.querySelector('.timer-content').classList.toggle('hidden');
      document.getElementById('timerMinimizedContent').classList.toggle('hidden');
    });

    document.getElementById('autoPrioritizeBtn').addEventListener('click', () => {
      alert('‚ú® Tasks auto-prioritized!\n\nCheck the Smart Priority Queue for your top priorities.');
      render();
    });

    document.getElementById('refreshPriority').addEventListener('click', () => {
      render();
    });

    // Search/Command palette
    document.getElementById('searchInput').addEventListener('focus', () => {
      document.getElementById('commandPalette').classList.add('open');
      document.getElementById('commandInput').focus();
    });

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('commandPalette').classList.add('open');
        document.getElementById('commandInput').focus();
      }
      if (e.key === 'Escape') {
        closeTaskModal();
        document.getElementById('commandPalette').classList.remove('open');
      }
    });

    document.getElementById('commandPalette').addEventListener('click', (e) => {
      if (e.target.id === 'commandPalette') {
        document.getElementById('commandPalette').classList.remove('open');
      }
    });

    // Init
    if (Object.keys(store.tasks).length === 0) {
      store.addTask({ title: 'Welcome to PrioBox! üëã', quadrant: 'do-first', estimatedMinutes: 5 });
      store.addTask({ title: 'Try the Focus Timer', quadrant: 'do-first', estimatedMinutes: 25 });
      store.addTask({ title: 'Plan your week', quadrant: 'schedule', estimatedMinutes: 30 });
    }

    render();
    timer.updateDisplay();
  </script>
</body>
</html>
